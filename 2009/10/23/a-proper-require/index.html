<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>2009 10 23 a proper require\7R4N5C0D3</title>
  <meta name="author" content="Trans" />

  <link rel="icon" type="image/png" href="/assets/images/trans-logo.png">

  <link rel="stylesheet" href="/assets/styles/main.css" type="text/css"/> 
  <link rel="stylesheet" href="/assets/styles/code.css" type="text/css"/>  
  <link rel="stylesheet" href="/assets/styles/pygment.css" type="text/css"/>

  <link rel="stylesheet" href="/assets/styles/custom.css" type="text/css"/>
  <link rel="stylesheet" href="/assets/styles/social.css" type="text/css"/>  

  <link href='http://fonts.googleapis.com/css?family=Jura:400,500' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>

  <!--[if lt IE 9]>
  <script src="/scripts/html5.js"></script>
  <![endif]-->

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

  <script type="text/javascript" src="/assets/scripts/jquery.easing.js"></script>
  <script type="text/javascript" src="/assets/scripts/jquery.social.share.1.2.min.js"></script>

  <script src="/assets/scripts/main.js"></script>

  <script>
    $(document).ready(function(){
      $('#social-share').dcSocialShare({
        twitterId: 'transgigamic',
        tabText: '<img src="/assets/images/tab_share.png" alt="Share" />',
        buttons: 'twitter,facebook,plusone,stumbleupon,digg,linkedin,pinit'
      });
    });
  </script>

  <!-- tracking code here ? -->
</head>

<body>
<div id="container">

	<div id="header">
		<h1>7R4N5C0D3</h1>
	</div>

	<div id="nav">
    <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/Projects">Projects</a></li>
    <li><a href="/Reads">Reads</a></li>
    <li><a href="/Tools">Tools</a></li>
    <li><a href="/tags.html">Tags</a></li>
    <li><a href="/atom.xml">Feed</a></li>
    <li><a href="https://github.com/trans/trans.github.com/wiki">Wiki</a> &gt;&gt;</li>
    </ul>
	</div>

<!-- CONTENT -->
<div id="content-wrapper">
<div id="content">

<h1>A Proper Require</h1>

<p>Recently I <a href="http://groups.google.com/group/ruby-talk-google/browse_thread/thread/6a46c837ffc84761">posted</a>
a light diatribe against improper use of relative requires in Ruby programs.
I pointed-out a bit of code, I recently came across, that added a relative path to Ruby's
<code>$LOAD_PATH</code> from within a <code>bin/</code> executable.</p>

<pre><code>$LOAD_PATH.unshift(File.expand_path(File.dirname(__FILE__) + "/../lib"))
</code></pre>

<p>I suspect the author little realized that his program would not function if it were installed
according to traditional <a href="http://www.pathname.com/fhs/">FHS</a>-based standards. And I fear many
young Rubyists, having known nothing but the use of RubyGems and/or deployment (as opposed to release)
of Rails apps, do not understand the nature of the issue. In my post I stated some general rules.</p>

<h2>The Rules of Relative Loading</h2>

<ul>
<li>Don't mess with the <code>$LOAD_PATH</code>.</li>
<li>Use relative lookup only when you must, eg. using bundled HTML templates.</li>
<li>Any relative paths you do use must remain within the confines of their main directory (eg. lib/)</li>
<li>Don't use a relative lookup for any .rb or .so/.dll loading.</li>
<li>It should never be necessary to require 'rubygems'.</li>
</ul><p><a href="http://blog.grayproductions.net/">James Edward Gray II</a> pointed out that
I had not been clear in stating the exceptions to these rules, so I add the
following.</p>

<h2>When the Rules Do <em>Not</em> Apply</h2>

<ul>
<li>They do not apply to Rails Apps since they are deployed, rather than packaged and installed.</li>
<li>Testing and building scripts are free from the rules since they are localized operations.</li>
</ul><p>Even when the rules do not apply, try to adhear to them as much as possible. For exmaple, minimize
the points of entry. At the very least it can benefit refactoring.</p>

<h2>Understanding the Rules</h2>

<p>Most of the responses to my post expressed understanding of the last rule, as there have been a few
write-ups on that subject before. But many could not understand the reasons behind the other points.
And it's no wonder. I did some research and discovered there to be a fair bit of misinformation
circulating promoting the use of relative loading as a "proper" solution, and very little information
explaining what is actually best practice.</p>

<p>It was the last reply to my post that made me realize I should take a moment to write this 
blog entry to more fully explain.</p>

<blockquote>
"As someone who wrote a dependency-resolving code loading gem, I am extremely
dubious that one can always avoid code loading using relative paths.
How would you ordinarily go about loading some .rb files in a subdirectory
beneath the directory in which the current file is located?"
</blockquote>

<p>Clearly we have a quite capable programmer here, having written "a dependency-resolving code loading gem",
but the fact the he states that he wrote a "gem" rather then a "library" struck me as an indication
that some crucial old school knowledge is missing from his repertoire that inevitably lead him to
his second sentence.</p>

<p>The key, I believe, to alleviating this misunderstanding is Minero Aoki's <a href="http://i.loveruby.net/en/projects/setup/">Setup.rb</a>.
Before we had RubyGems, Aoki's <code>setup.rb</code> script was <em>the</em> way to install Ruby software, and his
work helped lay the foundation for the way in which Ruby projects are structured to this very day. The
first two sections of the Setup.rb <a href="http://i.loveruby.net/en/projects/setup/doc/">documentation</a>
should be required reading for all Rubyists.</p>

<p>Once we understand how Setup.rb works --where it puts a project's files upon installation, we can
then understand when we can and when we cannot get away with using relative requires. However, even
when we can do so, it does not mean we should. The idea of Setup.rb is to install your files
into the system locations where the <code>$LOAD_PATH</code> is already set to look. In other words,
you should not effect the <code>$LOAD_PATH</code> in your code, but make sure your code is where
the <code>$LOAD_PATH</code> expects it to be. The <code>$LOAD_PATH</code> is something managed externally,
by a system administrator, or a specially designed program for just such a purpose (like RubyGems).
By placing our code in the correct system locations, we will only ever need standard 
<code>require 'mylib/mysubdir/myfile'</code> type load calls.</p>

<h2>How to Follow the Rules</h2>

<p>So how do we make sure our code is where it needs to be? In the old days we just used <code>setup.rb</code>.
By following it's conventions and installing our software with it, all was well. But today most Rubyists
use RubyGems. That works just as well, but there are two configuration issues that attend it's use.</p>

<ol>
<li>Our project's gemspec must have the proper <code>require_paths</code> setting. The default is the setup.rb standard <code>lib/</code>.</li>
<li>Our RUBYOPT environment setting must contain "-rubygems".</li>
</ol><p>As I mentioned in the above bullet points, it is okay to add to the <code>$LOAD_PATH</code> when running tests --that's essential to avoid having to reinstall your project after every code change. But it's not acceptable to do so in your actual program.</p>

<p>I believe Minero Aoki has completed his work on Setup.rb, as there has not been any activity on his project
in some time. A while ago, I <a href="http://github.com/proutils/setup">forked Setup.rb</a> in order to make it a stand-alone package that can be installed via RubyGems. Since then I have continued it's development, working on few aspects of the system such as using optparse.rb for command-line parsing, removing the (unused) multi-package feature, adding doc/ installation and most recenty I started to rewrite the install code to be atomic (would love some assistance on that, btw!).</p>

<p>With the advent of RubyGems, <code>setup.rb</code> is not as widely needed as it once was (though it still gets used in some cases). Yet the ground work it laid is still with us, and should be understood if one wishes to be an effective Ruby programmer.</p>

<hr><p>title      : A Proper Require
author     : trans
categories : [ruby, require]
date       : 2009-10-23
layout     : post</p>

<!--
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    {% for post in site.related_posts limit:3 %}
      <li><span class="post-date">July 07, 2012</span> &raquo; <a href="">2009 10 23 a proper require</a></li>
    {% endfor %}
  </ul>
</div>
-->

</div>
</div>
<!-- END CONTENT -->

<!-- Start Shareaholic Sexybookmarks -->
<div class="shr_class shareaholic-show-on-load">
</div>

<script type="text/javascript">
var SHRSB_Settings = {"shr_class":{"src":"/assets/shareaholic","link":"","service":"236,45,5,7,88,92,61,204,202,102,3,40,10,2,38,195,27,48,6,1,218,24,46,267,74,191,265,219,210,78,240,207,54,53,52,201","apikey":"6ffe2cbf142c45bd4cd03b01ec46b8658","localize":true,"shortener":"google","shortener_key":"","designer_toolTips":true,"twitter_template":"${title} - ${short_link} via @Shareaholic"}};
</script>

<script type="text/javascript">
(function() {
var sb = document.createElement("script"); sb.type = "text/javascript";sb.async = true;
sb.src = ("https:" == document.location.protocol ? "https://dtym7iokkjlif.cloudfront.net" : "http://cdn.shareaholic.com") + "/media/js/jquery.shareaholic-publishers-sb.min.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(sb, s);
})();
</script>
<!-- End Shareaholic Sexybookmarks -->

<!-- Start Disqus Commments -->
<div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /**
     * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
     */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://transcode.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=transcode">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<!-- End Disqus Commands -->

<div id="social-share"></div>

<!-- FOOTER -->

<div id="footer">
  <div class="tiger">
  </div>
	<small>Last edited by <b>trans</b> on July 07, 2012.</small>
	<small style="float:right;">
		This site is a <a href="https://github.com/blog/699-making-github-more-open-git-backed-wikis">GitHub Wiki</a>
		mirror powered by <a href="http://rubyworks.github.com/smeagol">Smeagol</a>.
	</small>
</div>

</div>
</body>
</html>

