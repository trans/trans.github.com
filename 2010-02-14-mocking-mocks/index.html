<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>7R4N5.C0D3 - Mocking Mocks</title>

    <link rel="stylesheet" href="/smeagol/main.css" type="text/css"/> 
    <link rel="stylesheet" href="/smeagol/pygment.css" type="text/css"/>

    <link rel="stylesheet" href="/assets/styles/custom.css" type="text/css"/> 

    <style>
      body{ color: #222; background: url(assets/images/bg.jpg); padding: 0; margin: 0; }

      header{ color: #222; height: 60px; margin: 0; padding: 30px 0; font-family: courier, monospace; font-size: 48px; }
      header h1 { margin-top: 20px; color: #222; text-shadow: 0px 0px 5px white; }
      header h2 { color: #cccccc; text-shadow: 0px 0px 5px black; padding: 5px 0 20px 15px; }

      nav{ padding: 1em; background: #000; opacity: 0.8; border: none; }
      nav ul li a{ color: #eee; }
      nav ul li a:hover{ color: #59c; }

      #content{ color: #222; padding: 1em; width: 550px; margin: 0; background: #fff; }
      #content h1 { color: #222; }
      #content h2 { color: #222; }
      #content p { color: #222; }

      #sidebar{margin-bottom: 20px; padding: 20px; background: #fff; border: 1px solid #ccc; min-height: 100px; box-shadow: 5px 5px 10px #ccc; }
      #sidebar h1,h2 { font-family: times; }
      #sidebar h2 { font-size: 2em; margin: 10px 0 10px 0; }

      footer{width: 550px; color:#222; margin-top:20px; padding:20px; border:none; background:#fff; }

      #container{ margin: 0 auto; padding 0; width: 900px; }

      .tab { display: none; }
    </style>

    <!--[if lt IE 9]>
    <script src="/smeagol/html5.js"></script>
    <![endif]-->

    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

    <script>
      $(document).ready(function(){
        show('#am');
      });
    </script>

    <script>
      function show(id){
        $('.tab').hide();
        $(id).fadeIn();
      };
    </script>

</head>

<body>
	
	
    <div id="container">
		<header>
			<h1>7R4N5.C0D3</h1>
		</header>

		<nav>
      <button onMouseOver="show('#am');">I AM</button>
      <button onMouseOver="show('#make');">I MAKE</button>
      <button onMouseOver="show('#ad');">I AD</button>
      <button onMouseOver="show('#use');">I USE</button>
      <button onMouseOver="show('#read');">I READ</button>
		</nav>

    <div id="sidebar">
      <div id="am" class="tab">
        <h2 class="side-title">I Am</h2>
        <p>Trans has been coding Ruby since 2002. Now he shares with you. Kazaam!</p>
      </div>

      <div id="make" class="tab">
        <h2 class="side-title">I Make</h2>
        <div style="text-align: center;">
          <a href="http://rubyworks.github.com"><img src="/assets/images/rubyworks.png" style="width: 250px;" /></a><br/>
          <a href="http://rubyworks.github.com/facets"><img src="/assets/images/RubyFacets.png" style="width: 270px;"/></a><br/>
          <a href="http://death.rubyforge.org"><img src="/assets/images/skull4.png" style="margin-top: 0;"/></a><br/>
        </div>
      </div>

      <div id="ad" class="tab">
        <h2 class="side-title">I Advertise</h2>
        <div style="text-align: center;">
          <script type="text/javascript"><!--
          google_ad_client = "pub-1126154564663472";
          /* RUBYWORKS 09-10-02 728x90 */
          google_ad_slot = "0788888658";
          google_ad_width = 728;
          google_ad_height = 90;
          //-->
          </script>
          <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
          </script>
        </div>
      </div>

      <div id="use" class="tab">
        <h2 class="side-title">I Use</h2>
        <a href="http://ruby-lang.org"><img src="/assets/images/ruby-lang.png"/></a><br/>
        <a href="http://github.org"><img src="/assets/images/github-logo.png" style="float: left; margin-left: 5px; width: 115px;"/></a>
        <a href="http://github.org"><img src="/assets/images/jquery-logo.gif" style="margin-left: 10px;"/></a>
        <a href="http://cukes.info/"><img src="/assets/images/cuke_logo.png"/></a>
      </div>

      <div id="read" class="tab">
        <h2 class="side-title">I Read</h2>
        <a href="http://rubyinside.com/"><img src="http://www.rubyinside.com/wp-content/themes/rubyinside2009/images/logo2.png" align="center"/></a>
      </div>

      <div id="work" class="tab">
        <h2 class="side-title">I Work</h2>
        <div id="github-badge"></div>
        <script type="text/javascript" charset="utf-8">
          GITHUB_USERNAME="trans";
        </script>
        <script src="http://drnic.github.com/github-badges/dist/github-badge-launcher.js" type="text/javascript"></script>
      </div>
    </div>

		<article>
			<h1>Mocking Mocks</h1>
    	<div id="content">
<h1>Mocking Mocks</h1>

<p>There are a variety of test-double/mocking libraries available for Ruby.
<a href="http://mocha.rubyforge.org/">Mocha</a> is probably the most well known.
<a href="http://rspec.info/">RSpec</a> comes with it's own mock library. I beleive
<a href="http://flexmock.rubyforge.org/">FlexMock</a> is the venerable older gentleman
on the block. And there are plenty of alternatives such as
<a href="http://rubyforge.org/projects/double-ruby">rr</a> and <a href="http://github.com/jm/stump">stump</a>.</p>

<p>I myself have been toying with an implementation, with a goal of maximizing ease
of use and implemetation overhead. In my pursuit I discovered something very
interesting: Ruby doesn't necessairly need a test-double library.</p>

<p>Consider the case of a pure <em>stub</em>. Ruby's Struct class makes pure stubs 
ridiculously easy.</p>

<div class="highlight"><pre>    <span class="n">stub</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"Hello, World!"</span><span class="p">)</span>
    <span class="n">stub</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; "Hello, World!"</span>
</pre>
</div>


<p>And because Struct.new returns a class, they can be reused, adjusted and 
inherited, like any other Ruby class --pretty sweet.</p>

<p>How about the case of a <em>partial stubs</em>. Since Ruby supports singleton methods,
it is a simple matter of latching a new or overriding method onto an object.</p>

<div class="highlight"><pre>    <span class="n">obj</span> <span class="o">=</span> <span class="s2">"my object"</span>

    <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">to_s</span>
      <span class="s2">"mocking "</span> <span class="o">+</span> <span class="k">super</span>
    <span class="k">end</span>
</pre>
</div>


<p>I mean, how easy can it get? </p>

<p>Ok. So stubs are easy, but how about <em>mocks</em>? Well, let's first consider what I
call <em>light-weight mocks</em>. These are like mocks in that the set-up conditions
on message invocations, but unlike regular mocks they are triggered during
invocation rather than awaiting a special trigger method (eg. <code>#verify</code>). Again,
these are easy in Ruby. (Note: I am using the <a href="http://proutils.github.com/ae">AE</a>
library for my assertions syntax.)</p>

<div class="highlight"><pre>    <span class="n">obj</span> <span class="o">=</span> <span class="s2">"my object"</span>

    <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">to_s</span>
      <span class="n">result</span> <span class="o">=</span> <span class="k">super</span>
      <span class="n">result</span><span class="o">.</span><span class="n">assert</span> <span class="o">=~</span> <span class="sr">/^my/</span>
      <span class="n">result</span>
    <span class="k">end</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">to_s</span>
</pre>
</div>


<p>I would argue in most cases light-weight mocks are more than sufficient for most
testing needs. Regular mocks have a tendency to become too enmeshed in implementation,
which creates undo maintenance headaches. Nonetheless, bare with me and we 
we see how to do regular mocks in pure Ruby as well.</p>

<p>Before we get to regular mocks we first need to consider the test <em>spy</em>. Check it out.
We will use one simple helper from Ruby Facets, called Functor.</p>

<div class="highlight"><pre>    <span class="nb">require</span> <span class="s1">'facets/functor'</span>
</pre>
</div>


<p>If you are wondering, the functor is nothing more than a BasicObject that redirects
<code>#missing_method</code> calls to the block you supply it.</p>

<div class="highlight"><pre>    <span class="n">obj</span> <span class="o">=</span> <span class="s2">"my object"</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="no">Functor</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">|</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">rec</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">]</span>
      <span class="n">r</span>
    <span class="k">end</span>

    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
</pre>
</div>


<p>All we are doing here is intercepting the calls to <code>obj</code> by delegating through <code>spy</code>.
A record of activity is then being stored in the <code>rec</code> array. With it we can
verify, for instance, that <code>#to_s</code> was called.</p>

<div class="highlight"><pre>    <span class="n">msg</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">|</span> <span class="n">op</span> <span class="o">==</span> <span class="ss">:to_s</span> <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre>
</div>


<p>And that it returned what was expected.</p>

<div class="highlight"><pre>    <span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s2">"my object"</span><span class="p">)</span>
</pre>
</div>


<p>Or we can even verify how many times it was called. Lets call it two more times
to be sure.</p>

<div class="highlight"><pre>    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="o">|</span> <span class="n">op</span> <span class="p">}</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</pre>
</div>


<p>A little verbose, but nothing too terribly strenuous to understand.</p>

<p>Alright. So now lets turn to full-fledge <em>mocks</em>. As you might have
suspected, mocks are a trivial derivation of spies. All we need to do
is collect our verifications together on a per-method bases and run
through them subsequent to invocations in question.</p>

<p>First lets reset our target object and spy.</p>

<div class="highlight"><pre>    <span class="n">obj</span> <span class="o">=</span> <span class="s2">"my object"</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="no">Functor</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">|</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">rec</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">]</span>
      <span class="n">r</span>
    <span class="k">end</span>
</pre>
</div>


<p>We will store out verifications in a Hash.</p>

<div class="highlight"><pre>    <span class="n">verify</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]=[]</span> <span class="p">}</span>
</pre>
</div>


<p>We define our verification procedures.</p>

<div class="highlight"><pre>    <span class="n">verify</span><span class="o">[</span><span class="ss">:to_s</span><span class="o">]</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">recs</span><span class="o">|</span> 
      <span class="n">recs</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="s2">"my object"</span>
      <span class="n">recs</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">end</span>
</pre>
</div>


<p>Now we can execute the code in question.</p>

<div class="highlight"><pre>    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
</pre>
</div>


<p>And verify by iterating over and calling each verification procedure.</p>

<div class="highlight"><pre>    <span class="n">verify</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vop</span><span class="p">,</span> <span class="n">tst</span><span class="o">|</span>
      <span class="n">recs</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">select</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">|</span> <span class="n">vop</span> <span class="o">==</span> <span class="n">op</span> <span class="p">}</span>
      <span class="n">tst</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span>
    <span class="k">end</span>
</pre>
</div>


<p>Granted that by the time we get to mocks, the code has gotten a little
more complex and certainly not as pretty as a dedicated mock library.
Nonetheless, what is remarkable here is that it takes so little to get
so much out of Ruby. With a few helper methods wrapping some of the
above code segments we would hardly know we weren't working with
a full-fledged mocking library.</p>

<p>Moreover as I argued above, one rarely needs to go this far to get
perfectly good test-doubles. Light-weight mocks will cover most
contingencies just as well as their full-fledged brethren without
the worry of taking your tests too far into the realm of implementation
detail.</p>

<hr /><p>title      : Mocking Mocks
author     : trans
date       : 2010-02-14
categories : [tdd, bdd, test, mock]
layout     : post</p>
			</div>
		</article>

		<footer>
			<small>Last edited by <b>7rans</b> on December 03, 2011.</small>
			<small style="float:right;">
				This site is a <a href="https://github.com/blog/699-making-github-more-open-git-backed-wikis">GitHub Wiki</a>
				mirror powered by <a href="http://smeagolrb.info">Smeagol</a>.
			</small>
		</footer>
    </div>
</body>
</html>
