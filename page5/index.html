<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRANSCODE &mdash; Trans Technology and Programming Blog</title>
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/trans-logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="TRANSCODE" />
    <meta name="title" content="TRANSCODE">
    <link rel="canonical" href="http://trans.github.com/page5/">
     
           
    <meta property="og:title" content="TRANSCODE"/>
    <meta property="og:url" content="http://trans.github.com/page5/"/>
    
    
    <meta property="og:site_name" content="TRANSCODE">
</head>
<body>
    
<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
                <img src="/images/trans-logo.png" alt="Inc" height="120px">
            </a>
            <a href="/" class="home">Blog</a>
            <a href="http://github.com/trans">Github</a>
            <a href="/About/">About</a>
        </nav>
        <nav class="tagline">
            <span>Check out all of my open source work</span>
            <a href="http://github.com/trans" class="btn btn-outline">Learn More</a>
        </nav>
    </header>
</section>

<div class="blog-cover" style="background-image:url(/images/blog-cover.jpg);">
    
    <section>
        <div class="container">
            <h1>TRANSCODE</h1>
            <h3>Trans Technology and Programming Blog</h3>
        
            
            <a href="https://twitter.com/transgigamic" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter"></i></a>
            
            
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss"></i>
            </a>
        </div>
    </section>
</div>

<article class="container">

  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/05/13/directory-based-configuration/" rel="prefetch">Directory Based Configuration</a></h2>
            <p><h1>Directory-based Configuration</h1>

<p>With regards to <a href="http://proutils.github.com/pom">POM</a>, 
the most cumbersome issue I have had to struggle with over the course
of its long and somewhat painful development, is the question of
configuration storage. You see, many years ago I hit upon the idea of
using the file system itself as a &quot;hash&quot; for heirarchical storage.
In other words, instead of using a YAML or JSON or an INI file, POM could
use the file system itself.</p>

<p>For example, lets say we have a config file <code>pom.yaml</code>:</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml">    <span class="l-Scalar-Plain">---</span>
    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">POM</span>
    <span class="l-Scalar-Plain">summary</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Project Object Model for Ruby</span>
    <span class="l-Scalar-Plain">authors</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Trans</span>
    <span class="l-Scalar-Plain">sites</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">homepage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://proutils.github.com/pom</span>
      <span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://github.com/proutils/pom</span>
</code></pre></div>
<p>Using the a directory-based configuration system instead
we would have this file hierachy:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">pom/
  name
  summary
  authors
  sites/
    homepage
    development
</code></pre></div>
<p>And each file would contain the data in plain text given in the YAML example above.</p>

<p><i>Does this seam crazy to you?</i>. I think, to most developers, this design will simply strike them as some form of mild insanity. However, I also think reason is mostly form a lack of familiarity, not the ideas relative merits. We are not accustomed to utilizing the file system in this fashion, so it is not surprising the initial reactions would be negative. But lets consider the benefits.</p>

<p>To it&#39;s advantage, a directory-based configuration does not need a support library to read, parse or write any data. Indeed, any coder can put together a viable system to handle directory-based configs in just a few lines of code. Becuase of this, any language, including shell scripts, can utilize the information. There is no concern that my language of choice won&#39;t be able to handle it. It also means that the computer can work with the data very easily, without disrupting the human readability of the same data. Whereas, a YAML file for instance, might become an ugly mess after a program rewrites the file in order to update a single entry. Along the same lines, it becomes very easy to scaffold entries. Copy some files and your good. Old files not specifically copied over remain intact. This &quot;low-bar&quot; of utilily gives directory-based configuration a huge advantage.</p>

<p>But if it is so great, why is it not common place already? Good question. The material cause is that file systems are piss-poor at efficiently storing small files. Even if the file contains a single byte of data most file systems will waste 4K to store it. Becuase of this <i>page size</i> issue the thought of storing many small files <i>on purpose</i> has never been taken seriously. This is changing however. It will be a few more years before the lastest systems are mainstream, but the next generation of file systems (which began I beleive with RieserFS 4) mitigate this problem to the point of irrelevance.</p>

<p>The other major disadvantage it the lack of tools. Because directory-based configuration is not widespread, there are no tools for making it easier to work with data layed out in this fashion. For instance, it is often convenient to edit a group of config options all at once. The best one can with he a directory structure is open a bunch of files simulataneously in a text editor (<code>gedit *</code>) --not an optimal solution. Another example are conversion tools, say converting the data to JSON for transimition via HTTP. To mitigate this we need to create tools that understand the idea of directory-based configuration and give us comfortable interfaces for working with the data within them.</p>

<p>So there are the relative merits, both good and bad, of directory-based configuration storage. If anyone has any others to add I would very muich to hear them. Going on this analysis, I think it is clear that the advantages out weigh the disadvantages since all the disadvantages are becoming or can be mitigated.</p>

<p>However, despite this, I have am seriously considering a move back to a file-based configuration. Why? Becuase directory-based configuration, while arguably better, is simply not common. In 5 to 10 years perhaps it will become more so, but until then it might simply be an design too far ahead of it&#39;s time to gain traction with any mainstrean developers. Clearly it is more important that a tool be found useful to a wide audiance, than it utilize a nifty feature, no matter how nifty it might be.</p>

<hr>

<p>title      : Directory-based Configuration
author     : trans
date       : 2010-05-13
categories : [pom, metadata, configuration]
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-13-May" title="May 13, 2010">May 13, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/04/13/a-case-for-module-inheritance/" rel="prefetch">A Case For Module Inheritance</a></h2>
            <p><h1>A Case for Module Inheritance</h1>

<p>I love beautifully written code. Unfortunately the realities of the
language sometimes clash with requirements of the implementation. While
Ruby goes a long way toward making beautifully written code common place.
It still has some shortcomings I&#39;d like to see improved.</p>

<p>Case in point are my endeavors of the last few days. I&#39;ve been struggling
to re-structure the code of the <a href="http://github.com/rubyworks/english/">English</a>
project. The primary purpose of the project is to provide extension methods to String,
pertaining to the English language. A good example are number inflection
methods #singular and #plural. At the same time I am trying to design
the library in such a way that other language modules can be built following
the same basic structure, and they could all work together if need be.</p>

<p>In the course of this endeavor I decided the best approach, keeping the future
squarely in mind, is to create a Language module, upon which English depends,
to house all the common logic of (most) languages. For example, the logic for
storing plural and singular special cases might be a good candidate since nearly
every language has to account for these. So the relationship between English 
and Language is clearly one of &quot;inheritance&quot; --I want to encapsulate logic at
a general level of abstraction, upon which more specific cases can inherit and
augment to fit their particular requirements.</p>

<p>In Ruby this kind of relationship is generally handled by class inheritance.
But here I run into an issue. <code>English</code> and <code>Language</code>
are modules, and they are modules because they are <i>singleton</i>. Now even
though we can include a module into another, which is akin to class inheritance,
it does not work quite like class inheritance. For one thing, metaclass methods
are not inherited via <code>include</code>. Of course, I could tip-toe around
this issue by using <code>extend</code>, since in this case I do not need
includable instance methods. But there is a much more subtle issues that
raises it&#39;s head: the dreaded Double Inclusion Problem. That&#39;s a serious
headache in my case because I want my end users to have the option to load
only the components they want to use as needed, rather than forcing them to
load the entire system up-front.</p>

<p>So, despite the many
<a href="http://www.google.com/search?q=singleton+pattern+evil">calls for the death
of the Singleton Pattern</a>, it looks like I might require it for my implementation
of English. Using modules simply comes with too many headaches and hackish work arounds.
Now I agree with all the Singleton nay-sayers. It is sort of an anti-pattern to 
create a class that will only ever have one instantiation and no state, but
the trade-off here is worse. If only...</p>

<p>It seems to me the truly fantastic solution to this would be if one module
could inherit from another just as we do with classes. And honestly, is there
really any reason we shouldn&#39;t be able to do this?</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">module Language

  def self.words(string)
    # generic definition
  end

end

module English &lt; Language

  def self.words(string)
    # override
  end

end
</code></pre></div>
<p>What is nice about this, something I know that Matz will appreciate, is that
it preserves single-inheritance, in contrast to the alternative of
turning <code>include</code> into a multiple-inheritance mechanism. And
for the love of code beauty, it would mean at least a reduction in use of the
all too common: </p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">def self.included(base)
  base.extend ClassMethods
end

module ClassMethods
  # ...
end
</code></pre></div>
<p>Not only is it ugly, it is even worse for those trying to inherit and
extend the behavior. Something more elegant is clearly desirable, and
Module Inheritance, as I have demonstrated here, might be just the ticket.</p>

<hr>

<p>title      : A Case for Module Inheritance
author     : trans
categories : [ruby]
date       : 2010-04-13
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-13-April" title="April 13, 2010">April 13, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/03/20/gutopia-revisited/" rel="prefetch">Gutopia Revisited</a></h2>
            <p><h1>GUtopIa Revisited</h1>

<p>Recently I had to buckle down and create and honest to goodness desktop GUI application in Ruby. So once again, after some six years, I set down to weigh my options. It saddens me to say, after all these years, the state of desktop GUI programming with Ruby is still a rather sorry affair. Yes, there have been many improvements --thanks to the hard work of many a good programmer, but the task of creating a Ruby-based GUI application still remains a very non-Ruby-esque ordeal.</p>

<p>My first attempt at it this time was with <a href="http://shoooes.net/">Shoes</a>. Shoes is a new and very nice GUI engine written largely from scratch by the well known WhyTheLuckyStiff. It&#39;s a noble effort and some really <a href="http://the-shoebox.org/">neat programs</a> can come from using Shoes. Unfortunately for my needs Shoes proved to be too buggy and immature --at times I saw visual artifacts and there are a very limited number of controls. And worst of all, the fact that it includes it&#39;s own Ruby interpretor and manges it&#39;s own gems caused it not to work well with some other libraries. For instance, I could not get it to use the latest version of Mechanize.</p>

<p>After examining other choices, such as creating one GUI script per major platform (too much work), or using the old standby FxRuby (never been happy with the lack of native look-and-feel), I decided to try a different course. I was well versed in web application design, so I tried my hand at rigging a web app to act like a desktop app via a locally running server using Ajax calls. The end result certainly looked good and basically worked. But there was a troubling lack of robustness in the interaction between the front-end and back-end. I had to poll the back-end to see what was going on, and the back-end had to spawn threads in order to provide a response to the browser while continuing to work on long-running processes. So it worked, but barely. I&#39;m sure it could be improved, but for a devote POLSer like myself, that meant getting into mucky waters I really didn&#39;t feel like I should need to be diving into anyway. Too bad. Web GUI design is quite advanced compared to Desktop GUI. Why no one has tried to map it directly to the desktop before is beyond me (but you can believe me when I tell you, I can&#39;t wait to delve into Plam&#39;s pre and it&#39;s <a href="http://developer.palm.com/webos_book/book1.html">webOS</a> development platform, which apparently does exactly this).</p>

<p>So where did this leave me? Well, I figured I had one last good shot with <a href="http://wxruby.rubyforge.org/wiki/wiki.pl">wxRuby</a>. Ironically I had something to do with the birth of that project. It was those six years ago that I first looked into GUI frameworks for Ruby. Rich Kilmer was talking about his Utopia/Alpha ideas and I was just starting to feel comfortable with writing scripts in Ruby. I decided there needed to be something better, and working off of Rich&#39;s idea&#39;s for an API I came up the idea of GUtopIa, which would supply a font-end API that anyone could interface to a back-end GUI framework. Sort of a best of all worlds kind of design. A number of people were psyched about the idea, and joined with me to discuss and pursue the project. Unfortunately, I was still wet behind the ears, and the fellow programmers who first entertained working with me didn&#39;t care much for my new-boy-brash style. They told me so, and decided on their own course, to create bindings for wxWidgets instead. I wasn&#39;t happy about it personally. Having studied wxWidgets some, I knew it would be a long time before anything really useful was to come of that project --if at all. In hindsight, while I still believe GUtopIa is a good idea, I am glad it&#39;s didn&#39;t proceed back then --I still had a lot to learn about Ruby before I could do something like that as well as I would really like.</p>

<p>So it was time to check out what the wxRuby team had accomplished. My first handful, or so, attempts were miserable failures. WxRuby has some issues. It is tempermental, and so much like the C API I felt like I was actually programming in C. This is not how Ruby programming is supposed to be! I was having real trouble getting anything more then a basic frame and menu to work. Frustrated with the straight coding approach, I decided to see what WYSIWYG form builders were to be had. I knew wxWidgets touted these, so I looked around and found the precisely named wxFormBuilder. This made it fairly easy to design my complex form and best of all it made it clearer to me how wxWidget GUIs are built. Unfortunately the generated markup, called an XRC file, had issues of it&#39;s own and wouldn&#39;t load properly into Ruby. Once again, I was at a dead end.</p>

<p>Something really needed to be done about this state of affairs. And so I have decided to resurrect the GUtopIa project. I found my old code, looked at it, scrapped it, and started fresh. I&#39;m going to proceed by specifying the front-end API as much as possible, before even considering back-end implementations. With any luck others will see what I&#39;m doing and offer to build a an interface to their favorite framework. So far what I have looks very sweet. Just to wet your whistle, here&#39;s a potential example.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">layout</span> <span class="o">=</span> <span class="no">GUtopIa</span><span class="o">::</span><span class="no">Layout</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;Name&#39;</span>  <span class="o">]</span><span class="p">,</span> <span class="o">[</span> <span class="n">entry</span> <span class="o">]</span> <span class="o">]</span>
      <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;Phone&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="o">[</span> <span class="n">entry</span> <span class="o">]</span> <span class="o">]</span>
      <span class="o">[</span> <span class="o">[</span> <span class="s1">&#39;EMail&#39;</span> <span class="o">]</span><span class="p">,</span> <span class="o">[</span> <span class="n">entry</span> <span class="o">]</span> <span class="o">]</span>
    <span class="k">end</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">show</span>
</code></pre></div>
<p>Yes, believe it or not, that&#39;s a fairly complete GUI layout. In an upcoming post I&#39;ll explain how it all works in more detail. But before I get into that, I still need a working desktop GUI application ASAP! I don&#39;t have time to develop GUtopIa for this. So now I&#39;ve tried again at coding wxRuby from hand, but this time using a very Ruby-esque lazy evaluation approach I had experimented with a long time ago in a <a href="http://www.rubyquiz.com/">Ruby Quiz</a> on <a href="http://www.rubyquiz.com/quiz10.html">crossword puzzle drawing</a>. Finally I got the results I wanted with out going cross-eyed looking at the code. Amazing how a well organized approach can make all the difference. I&#39;ll demonstrate my design in my next blog post.</p>

<hr>

<p>title      : GUtopIa Revisited
author     : trans
categories : [ruby, gui]
date       : 2010-03-20
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-20-March" title="March 20, 2010">March 20, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/02/25/code-identity/" rel="prefetch">Code Identity</a></h2>
            <p><h1>A Little Fun with Code Generation</h1>

<p>A couple of years ago, a 
<a href="http://blade.nagaokaut.ac.jp/cgi-bin/vframe.rb/ruby/ruby-talk/293058?292931-293646+split-mode-vertical">Ruby Quiz</a>
asked us <i>to print &quot;Hello, world!&quot; to standard output using Ruby in atypical fashion.</i>
Being the resolute over-achiever-to-a-fault that I am, I decided to take the proverbial
pie-in-the-sky highroad to metaland. If, I thought, I could define code <i>identities</i>,
akin to the mathematical kind, I should be able to have the computer simply
generate an endless stream of equivalent solutions. Indeed, it turned out that it wasn&#39;t
all that hard to code.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="k">class</span> <span class="nc">CodeIdentity</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">identities</span>
        <span class="vi">@identities</span> <span class="o">||=</span> <span class="o">[]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">identity</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">identities</span> <span class="o">&lt;&lt;</span> <span class="n">block</span>
      <span class="k">end</span>

      <span class="kp">attr_reader</span>   <span class="ss">:original</span>
      <span class="kp">attr_accessor</span> <span class="ss">:alternates</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="vi">@original</span> <span class="o">=</span> <span class="n">original</span>
        <span class="vi">@alternates</span> <span class="o">=</span> <span class="o">[</span><span class="n">original</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">work</span>  <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">dup</span>
        <span class="k">while</span><span class="p">(</span><span class="n">alternates</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span> <span class="k">do</span>
          <span class="n">alts</span> <span class="o">=</span> <span class="n">alternates</span><span class="o">.</span><span class="n">dup</span>
          <span class="n">size</span> <span class="o">=</span> <span class="n">alternates</span><span class="o">.</span><span class="n">size</span>
          <span class="n">alts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">alt</span><span class="o">|</span>
            <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">identities</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">identity</span><span class="o">|</span>
              <span class="nb">self</span><span class="o">.</span><span class="n">alternates</span> <span class="o">|=</span> <span class="o">[</span><span class="n">identity</span><span class="o">[</span><span class="n">alt</span><span class="o">]]</span>
              <span class="k">break</span> <span class="k">if</span> <span class="n">alternates</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">limit</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">show_code</span>
        <span class="n">alternates</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">code</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">show_output</span>
        <span class="n">alternates</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">run</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">generate_tests</span>
        <span class="nb">require</span> <span class="s1">&#39;test/unit&#39;</span>
        <span class="n">original_run</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:run</span><span class="p">)</span>
        <span class="n">testcase</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Test</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span><span class="p">)</span>
        <span class="n">alternates</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
          <span class="n">testcase</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>  
            <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;test_</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span>
              <span class="n">assert_equal</span><span class="p">(</span><span class="n">original_run</span><span class="p">,</span> <span class="n">runner</span><span class="o">[</span><span class="n">code</span><span class="o">]</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">so</span> <span class="o">=</span> <span class="vg">$stdout</span>
        <span class="n">sio</span> <span class="o">=</span> <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span>
        <span class="vg">$stdout</span><span class="p">,</span> <span class="vg">$stderr</span> <span class="o">=</span> <span class="n">sio</span><span class="p">,</span> <span class="n">sio</span>
        <span class="nb">eval</span> <span class="n">code</span><span class="p">,</span> <span class="vg">$TOPLEVEL_BINDING</span>
        <span class="n">result</span> <span class="o">=</span> <span class="vg">$stdout</span><span class="o">.</span><span class="n">string</span>
        <span class="vg">$stdout</span> <span class="o">=</span> <span class="n">so</span>
        <span class="n">result</span>
      <span class="k">end</span>

    <span class="k">end</span>
</code></pre></div>
<p>You can see from the #generate_tests method I was able to ensure that the results
were indeed equivalent (an interesting strategy in dynamic testing, perhaps
worth further exploration for production code).</p>

<p>After the <code>CodeIdentity</code> class all was required was to apply a little
<i>Brain Power</i> to come up some identities. I came up with a pretty simplistic lot,
just as proof of concept. By following the original email thread, no doubt we can see
their a assuredly an infinite number of possibilities that could be defined.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="k">class</span> <span class="nc">CodeIdentity</span>

      <span class="n">identity</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span>
        <span class="n">code</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/puts [&quot;](.*)[&quot;]/</span><span class="p">,</span> <span class="s1">&#39;print &quot;\1\n&quot;&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">identity</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span>
        <span class="n">code</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/puts [&quot;](.*)[&quot;]/</span><span class="p">,</span> <span class="s1">&#39;printf &quot;%s\n&quot; % [&quot;\1&quot;]&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">identity</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span>
        <span class="n">code</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[&quot;](.*)[&quot;]/</span><span class="p">,</span> <span class="s1">&#39;&quot;\1&quot;.reverse.reverse&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">identity</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span>
        <span class="n">code</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[&#39;](.*)[&#39;]/</span><span class="p">){</span> <span class="vg">$1</span><span class="o">.</span><span class="n">inspect</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">identity</span> <span class="k">do</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span>
        <span class="n">code</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[&#39;](.*)[&#39;]/</span><span class="p">){</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">//</span><span class="p">)</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">.join(&#39;&#39;)&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

    <span class="k">end</span>
</code></pre></div>
<p>To finish if off I wrote a small command-line interface that allow us to try any
piece of code and generate as many solutions as desired.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="k">if</span> <span class="bp">__FILE__</span> <span class="o">==</span> <span class="vg">$0</span>
      <span class="nb">require</span> <span class="s1">&#39;optparse&#39;</span>
      <span class="n">cnt</span> <span class="o">=</span> <span class="mi">20</span>
      <span class="no">OptionParser</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">opt</span><span class="o">|</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;number of solutions&quot;</span><span class="p">){</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">n</span> <span class="p">}</span>
      <span class="k">end</span><span class="o">.</span><span class="n">parse!</span>
      <span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="no">ARGF</span><span class="o">.</span><span class="n">read</span>
        <span class="no">ARGV</span><span class="o">.</span><span class="n">pop</span>
      <span class="k">else</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;puts &#39;Hello World!&#39;&quot;</span>
      <span class="k">end</span>
      <span class="n">cmd</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">first</span>

      <span class="n">scg</span> <span class="o">=</span> <span class="no">CodeIdentity</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
      <span class="n">scg</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>

      <span class="k">case</span> <span class="n">cmd</span>
      <span class="k">when</span> <span class="s1">&#39;test&#39;</span>
        <span class="n">scg</span><span class="o">.</span><span class="n">generate_tests</span>
      <span class="k">when</span> <span class="s1">&#39;output&#39;</span>
        <span class="n">scg</span><span class="o">.</span><span class="n">show_output</span>
      <span class="k">else</span>
        <span class="n">scg</span><span class="o">.</span><span class="n">show_code</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div>
<p>Without any options it works on the old favorite <code>puts &#39;Hello, World&#39;</code>
and produces 20 solutions. Here&#39;s the output:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="nb">puts</span> <span class="s1">&#39;Hello, World!&#39;</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello, World!&quot;</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Hello, World!</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="o">[</span><span class="s2">&quot;Hello, World!&quot;</span><span class="o">]</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello, World!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="o">[].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s2">&quot;Hello, World!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span>
    <span class="nb">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="o">[</span><span class="s2">&quot;Hello, World!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">]</span>
    <span class="nb">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="o">[</span><span class="s2">&quot;Hello, World!&quot;</span><span class="o">].</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello, World!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="o">[].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="o">[].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="nb">puts</span> <span class="o">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="o">[].</span><span class="n">join</span><span class="p">(</span><span class="o">[].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)))</span>
    <span class="nb">print</span> <span class="s2">&quot;Hello, World!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">reverse</span>
</code></pre></div>
<p>Very simplistic, but an interesting and fun diversion. Granted others came up with more intriguing 
individual solutions. But I manged to come up with an infinite set of them! ;) </p>

<p>(The full code is available in <a href="http://gist.github.com/313518">Gist #313518</a>.)</p>

<hr>

<p>title      : Code Identity
author     : trans
categories : [ruby, identity]
date       : 2010-02-25
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-25-February" title="February 25, 2010">February 25, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/02/14/mocking-mocks/" rel="prefetch">Mocking Mocks</a></h2>
            <p><h1>Mocking Mocks</h1>

<p>There are a variety of test-double/mocking libraries available for Ruby.
<a href="http://mocha.rubyforge.org/">Mocha</a> is probably the most well known.
<a href="http://rspec.info/">RSpec</a> comes with it&#39;s own mock library. I beleive
<a href="http://flexmock.rubyforge.org/">FlexMock</a> is the venerable older gentleman
on the block. And there are plenty of alternatives such as
<a href="http://rubyforge.org/projects/double-ruby">rr</a> and <a href="http://github.com/jm/stump">stump</a>.</p>

<p>I myself have been toying with an implementation, with a goal of maximizing ease
of use and implemetation overhead. In my pursuit I discovered something very
interesting: Ruby doesn&#39;t necessairly need a test-double library.</p>

<p>Consider the case of a pure <em>stub</em>. Ruby&#39;s Struct class makes pure stubs 
ridiculously easy.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">stub</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
    <span class="n">stub</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; &quot;Hello, World!&quot;</span>
</code></pre></div>
<p>And because Struct.new returns a class, they can be reused, adjusted and 
inherited, like any other Ruby class --pretty sweet.</p>

<p>How about the case of a <em>partial stubs</em>. Since Ruby supports singleton methods,
it is a simple matter of latching a new or overriding method onto an object.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">to_s</span>
      <span class="s2">&quot;mocking &quot;</span> <span class="o">+</span> <span class="k">super</span>
    <span class="k">end</span>
</code></pre></div>
<p>I mean, how easy can it get? </p>

<p>Ok. So stubs are easy, but how about <em>mocks</em>? Well, let&#39;s first consider what I
call <em>light-weight mocks</em>. These are like mocks in that the set-up conditions
on message invocations, but unlike regular mocks they are triggered during
invocation rather than awaiting a special trigger method (eg. <code>#verify</code>). Again,
these are easy in Ruby. (Note: I am using the <a href="http://proutils.github.com/ae">AE</a>
library for my assertions syntax.)</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">to_s</span>
      <span class="n">result</span> <span class="o">=</span> <span class="k">super</span>
      <span class="n">result</span><span class="o">.</span><span class="n">assert</span> <span class="o">=~</span> <span class="sr">/^my/</span>
      <span class="n">result</span>
    <span class="k">end</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">to_s</span>
</code></pre></div>
<p>I would argue in most cases light-weight mocks are more than sufficient for most
testing needs. Regular mocks have a tendency to become too enmeshed in implementation,
which creates undo maintenance headaches. Nonetheless, bare with me and we 
we see how to do regular mocks in pure Ruby as well.</p>

<p>Before we get to regular mocks we first need to consider the test <em>spy</em>. Check it out.
We will use one simple helper from Ruby Facets, called Functor.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="nb">require</span> <span class="s1">&#39;facets/functor&#39;</span>
</code></pre></div>
<p>If you are wondering, the functor is nothing more than a BasicObject that redirects
<code>#missing_method</code> calls to the block you supply it.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="no">Functor</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">|</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">rec</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">]</span>
      <span class="n">r</span>
    <span class="k">end</span>

    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
</code></pre></div>
<p>All we are doing here is intercepting the calls to <code>obj</code> by delegating through <code>spy</code>.
A record of activity is then being stored in the <code>rec</code> array. With it we can
verify, for instance, that <code>#to_s</code> was called.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">msg</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">|</span> <span class="n">op</span> <span class="o">==</span> <span class="ss">:to_s</span> <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
<p>And that it returned what was expected.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;my object&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Or we can even verify how many times it was called. Lets call it two more times
to be sure.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="o">|</span> <span class="n">op</span> <span class="p">}</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<p>A little verbose, but nothing too terribly strenuous to understand.</p>

<p>Alright. So now lets turn to full-fledge <em>mocks</em>. As you might have
suspected, mocks are a trivial derivation of spies. All we need to do
is collect our verifications together on a per-method bases and run
through them subsequent to invocations in question.</p>

<p>First lets reset our target object and spy.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="no">Functor</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">|</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">rec</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">]</span>
      <span class="n">r</span>
    <span class="k">end</span>
</code></pre></div>
<p>We will store out verifications in a Hash.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">verify</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]=[]</span> <span class="p">}</span>
</code></pre></div>
<p>We define our verification procedures.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">verify</span><span class="o">[</span><span class="ss">:to_s</span><span class="o">]</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">recs</span><span class="o">|</span> 
      <span class="n">recs</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="s2">&quot;my object&quot;</span>
      <span class="n">recs</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">end</span>
</code></pre></div>
<p>Now we can execute the code in question.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
</code></pre></div>
<p>And verify by iterating over and calling each verification procedure.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">verify</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vop</span><span class="p">,</span> <span class="n">tst</span><span class="o">|</span>
      <span class="n">recs</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">select</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">|</span> <span class="n">vop</span> <span class="o">==</span> <span class="n">op</span> <span class="p">}</span>
      <span class="n">tst</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span>
    <span class="k">end</span>
</code></pre></div>
<p>Granted that by the time we get to mocks, the code has gotten a little
more complex and certainly not as pretty as a dedicated mock library.
Nonetheless, what is remarkable here is that it takes so little to get
so much out of Ruby. With a few helper methods wrapping some of the
above code segments we would hardly know we weren&#39;t working with
a full-fledged mocking library.</p>

<p>Moreover as I argued above, one rarely needs to go this far to get
perfectly good test-doubles. Light-weight mocks will cover most
contingencies just as well as their full-fledged brethren without
the worry of taking your tests too far into the realm of implementation
detail.</p>

<hr>

<p>title      : Mocking Mocks
author     : trans
date       : 2010-02-14
categories : [tdd, bdd, test, mock]</p>

<h2>layout     : post</h2>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-14-February" title="February 14, 2010">February 14, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/02/08/those-damn-version-numbers/" rel="prefetch">Those Damn Version Numbers</a></h2>
            <p><h1>Those Damn Version Numnbers</h1>

<p>Per the usual for a developer with too many projects on their hands,
I am constantly on the lookout for new tools to make my work easier.
Being the kind of person who likes to &quot;do it themselves&quot;, I often
end-up writing those tools. Recently I endeavored to make my life a bit
easier by automating, at least in part, my project&#39;s version numbers.
I thought, while only a partial help, that if I added a git post-commit
hook that bumped the patch number one, at the very least I could push
out patches without ever having to fuss with adjusting the version
number manually.</p>

<p><a href="http://book.git-scm.com/5_git_hooks.html">Git hooks</a>,
by the way, are a cinch to setup. Just edit the
<tt>.git/hooks/xxx</tt> script and turn on its user-executable
permission. As difficult as <tt>git</tt> itself can be to use at times,
this was about as easy as it could get --Developer&#39;s Hog Heaven.</p>

<p>Of course, I overlooked the simple fact that changing my project&#39;s
version file would itself need to be committed b/c it is also tracked
by the version control system, which would in turn invoke the hook,
modifying the version and requiring yet another commit, ad infinitum.
This wasn&#39;t going to work. Crap!</p>

<p>Yet, that little snafu really got the old brain juices flowing and
my fingers blogging. I want to make versioning my projects as simple as
Git&#39;s hooks are to create. Ultra-low maintenance and in need of barely
any consideration. Is it possible? I then thought about Ubuntu&#39;s
versioning policy. Now there&#39;s a low maintenance system! Just use the
release date. I like it. But... it doesn&#39;t tell you anything about the
release. Is it a major release? A minor release? Merely a bug fix?
Or a security fix? There&#39;s no way to tell. And consequently there is no
way to effect one&#39;s dependencies to use only a limited set versions per a
&quot;<a href="http://docs.rubygems.org/read/chapter/7">rational versioning policy</a>&quot;.</p>

<p>But wait a minute. What about these newfangled &quot;.a&quot; for alpha,
&quot;.b&quot; for beta, indicators that <a href="http://docs.rubygems.org/">RubyGems</a>
recently introduced? Aren&#39;t they a means communicating some fact about
the release? And yet are they really version numbers? They attempt
to emulate them by being single letters --sure we can enumerate by
letters just as well as numbers, but isn&#39;t that a shoe-horn --squeezing
information into a version &quot;look alike&quot; of sorts? And that being
the case, then hell with it, why not just do the whole version
scheme the same way.</p>

<p>To that end I propose we consider a new way to version, patterned
after date versions, a la Ubuntu, and augmented with informational
letter tags to tell us what kind of release with which we are dealing.
Let&#39;s consider some possible examples.</p>

<p>10.01.04      # major release
   10.01.05-m    # minor interface changes from previous release
   10.01.06-p    # patch release / bug fix to previous release
   10.02.11-s    # security fix to previous version
   10.04.06-a    # alpha release of next major version
   10.09.21-b    # beta release of next major version</p>

<p>That&#39;s a refreshingly simple scheme. All we would have to manually
specify at release time is the type via a single letter, the dating
is easily automated. (Note, I used a dash for no other reason than
it looked good to my eye. A dot could be used, or even nothing at
all. I really don&#39;t care what provides the delimitation myself.)</p>

<p>Granted, this version scheme doesn&#39;t tell us how many major releases or
minor releases or patch releases have been made since the project&#39;s inception.
But we don&#39;t really need to know that (and if we do we can just program our
package managers to run a summation). What we really need to know is simply
if there is a newer version than our current version, that it is a security fix,
or a minor update, or a major update, and so on, depending on our choice of
significance. Indeed I would even suggest that perhaps we add a some additional
types to help clarify further the type of release.</p>

<hr>

<p>title      : Damn Version Numbers
author     : trans
date       : 2010-02-08
categories : [versions, scm, development]
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-08-February" title="February 08, 2010">February 08, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2010/02/04/trygve-reenskaugs-dci-architecture/" rel="prefetch">Trygve Reenskaugs Dci Architecture</a></h2>
            <p><h1>Trygve Reenskaug&#39;s DCI Architecture</h1>

<p>In what has to be the best
<a href="http://architects.dzone.com/videos/dci-architecture-trygve">software development presentation</a>
I have seen in years, Trygve Reenskaug, one of the early computer
programming pioneers, takes us for a entertaining exploration of why
programming today is so broken and introduces us to a new &quot;level&quot;
to object oriented design he calls DCI (Data, Collaborations, and Interactions).</p>

<p>For some time, I have been having ideas and intuitions along much the same lines.
I even toyed with &quot;Orthogonal Ruby&quot; in which methods can be developed outside
of the classes they ultimately belong. So I was delighted to watch this, and see
a master like Reenskaug spell it out so clearly and actually provide working
demonstations in SmallTalk (the forbearer of Ruby&#39;s Object Model). </p>

<p>If you are at all interested in <i>The Next Big Thing In Programming</i>,
I highly recommend you check it out. <b>Warning!</b> It&#39;s lengthy! But obviously
I wouldn&#39;t tell you about it if I didn&#39;t think it was well worth the time.</p>

<hr>

<p>title      : Trygve Reenskaug&#39;s DCI Architecture
author     : trans
date       : 2010-02-04
categories : [oop, development]
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2010-04-February" title="February 04, 2010">February 04, 2010</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2009/12/13/a-failure-of-precedence/" rel="prefetch">A Failure Of Precedence</a></h2>
            <p><h1>A Failure of Precedence</h1>

<p>(Ruby&#39;s Operator Precedence Can Be Improved)</p>

<p>There&#39;s a lot to love about Ruby. Most of us know well the many great advantages it provides, as they say, &quot;making programming fun&quot;. However, Ruby is also notoriously dogged by a few small gotchas and inconsistancies. Some of these are understandable, such as the <a href="http://eigenclass.org/hiki/The+double+inclusion+problem">Double Inclusion Problem</a>; issues that are not worth the extensive effort to fix. On the other hand, some simple issues doggedly persist for little good reason (backward compatibility not withstanding).</p>

<p>One of these issues is operator precedence. Not only is operator precedence set in stone, it is also
woefully <i>bottom heavy</i> --there is only one binary operator available for use above the common arthmetic operations.</p>

<p>Here is the table as given by the <a href="https://www.cs.auckland.ac.nz/references/ruby/ProgrammingRuby/language.html">PickAxe</a>:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Method    Operator                Description
Y         [ ] [ ]=                Element reference, element set
Y         **                      Exponentiation
Y         ! ~ + -                 Not, complement, unary plus and minus (method names for the last two are +@ and -@)
Y         * / %                   Multiply, divide, and modulo
Y         + -                     Plus and minus
Y         &gt;&gt; &lt;&lt;                   Right and left shift
Y         &amp;                       Bitwise `and&#39;
Y         ^ |                     Bitwise exclusive `or&#39; and regular `or&#39;
Y         &lt;= &lt; &gt; &gt;=               Comparison operators
Y         &lt;=&gt; == === != =~ !~     Equality and pattern match operators (!= and !~ may not be defined as methods)
          &amp;&amp;                      Logical `and&#39;
          ||                      Logical `or&#39;
          .. ...                  Range (inclusive and exclusive)
            ? :                     Ternary if-then-else
          = %= { /= -= += |= &amp;=   Assignment
          &gt;&gt;= &lt;&lt;= *= &amp;&amp;= ||= **=   
          defined?                Check if symbol defined
          not                     Logical negation
          or and                  Logical composition
          if unless while until   Expression modifiers
          begin/end               Block expression
</code></pre></div>
<p>The lack of any operators other then <tt>**</tt>, above the most commonly used, <tt>* / % + -</tt>, puts
a frustrating limitation on the flexibility of this system. On this account, the most puzzling misplacement of an operator has to be Bitwise Exlusive Or, <tt>^</tt>. In many, if not most, programming languages <tt>^</tt> is the power operator. But in Ruby that function is delegated to <tt>**</tt>. While I personally do not favor <tt>**</tt> for the use, it&#39;s not something I mind either. However, that <tt>^</tt> doesn&#39;t share the same precedence is very awkward.</p>

<p>Consider for instance, the implementation of a unit system.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="mi">2</span><span class="o">.</span><span class="n">meters</span> <span class="o">**</span> <span class="mi">2</span>  <span class="o">=&gt;</span> <span class="s2">&quot;4 square meters&quot;</span>
</code></pre></div>
<p>Notice the power operator effects the unit and the value. So how would we go about notating <code>2 square meters</code>? We need some other means. The obvious answer is to redefine <tt>^</tt>:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="mi">2</span><span class="o">.</span><span class="n">meters</span> <span class="o">^</span> <span class="mi">2</span>  <span class="o">=&gt;</span> <span class="s2">&quot;2 square meters&quot;</span>
</code></pre></div>
<p>Great. But wait, there is an ugliness now upon us.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="mi">2</span><span class="o">.</span><span class="n">meters</span> <span class="o">^</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>  <span class="o">=&gt;</span> <span class="s2">&quot;2 meters&quot;</span>
</code></pre></div>
<p>The answer should have been <tt>1 square meter</tt>, but due to precedence <tt>2 / 2</tt> is barring a <tt>1</tt> before the <tt>^</tt> power operator kicks-in.</p>

<p>It is truly wonderful that Ruby&#39;s first 27 operators are actually methods, which means they can be defined to perform whatever function we would like of them. But despite being able to define these operators, there is no means of changing their precedence. Thus, the actual options we have defining new operations to suite our needs are hindered.</p>

<p>Ideally we would be able to alter precedence on a per-class basis. While, some might argue that would create too much confusion, I would retort that good libraries would use the feature effectively, limiting the changes to the appropriate use-cases, so that it would not be an issue. After all, a library that scrambles precedence for no damn good reason will get little use.</p>

<p>While we wait the day of true precedence freedom, I would like to see Ruby move <tt>^</tt> up with <tt>**</tt> and find a new Exclusive Or operator. Backward compatibility can be largely, although not completely, preserved by aliasing <tt>^</tt> to the new symbol. It&#39;s an obvious and simple improvement --a naggling issue that has been around for quite some time.</p>

<hr>

<p>title      : A Failure of Precedence
author     : trans
categories : [website]
date       : 2009-12-13
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2009-13-December" title="December 13, 2009">December 13, 2009</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2009/10/26/quiet-revolt-against-the-fhs/" rel="prefetch">Quiet Revolt Against The Fhs</a></h2>
            <p><h1>Quiet Revolt Against the FHS?</h1>

<p>Prompted by the disocvery of improper use of relative require in a number or Ruby project&#39;s executables, my last <a href="http://protuils.github.com/2009/10/proper-require.html">post</a> dicussed <i>why</i> and <i>when</i> to avoid using relative require. To summarize, there are two broad reasons to avoid relative loading. The first is simply YAGNI. In most cases you simply don&#39;t need to do it. Your script is on the $LOAD_PATH and all that is needed is the normal <code>require &#39;mylib/mydir/myfile&#39;</code> to load it. The second, and up until today I felt the more important concern, is conformance to the <a href="http://www.pathname.com/fhs/">File Hierarchy Standard</a>. While there is plenty of room to use relative requires and not tread on the FHS, it is easy enough to run afoul if one is not careful and aware of the issues. Such was the case with the executables.</p>

<p>Now I have discovered that another popular Ruby program is &quot;broken&quot; with regards to the FHS -- RDoc. In more recent versions, RDoc designed it&#39;s auto-loading of 3rd party templates to use <code>lib/rdoc/discover.rb</code>. In other words, if you want to create a template &quot;plug-in&quot; for RDoc you need to have a <code>lib/rdoc/discover.rb</code> file in your project in which you require the file(s) that contain your actual plug-in code. There is one serious problem with this. If more than one such 3rd-party template project is installed via an old-fashioned site_ruby install (eg. using setup.rb), then the last installed project&#39;s <code>discover.rb</code> file will clobber the prior&#39;s.</p>

<p>As a gem user you might not think it a big deal, but I can tell you that Linux distro maintainers do care. Any Ruby library they decide is worthy of a distro package, in particular a <code>.deb</code> package, they must ensure it conforms to the FHS. <a href="http://facets.rubyforge.org">Ruby Facets</a>, for instance, is slightly difficult in site install because it has two separate load paths. I received more that one nasty email about that when I no longer shipped a <code>setup.rb</code> script with the package. I have since updated the stand-alone version of <a href="http://proutils.github.com/setup">Ruby Setup</a> to handle such an install properly so long a <code>meta/loadpath</code> file is provided.</p>

<p>But now I have to wonder. If RDoc has a site install flaw in it&#39;s latest design, and the aforementioned use of relative loading in bin scripts in other projects is likewise flawed, not to mention the numerous other violations that are surely out there... Is there a quiet revolution against the FHS going-on? Perhaps a revolution by default, because people don&#39;t know any better or forget to take it into account?</p>

<p>Honestly, I have to say I hope so. In years past I had attempted to rail against the FHS. I even used <a href="http://gobolinux.org/">GoboLinux</a> as my main platform for a while. But as much as I would spout about the need to move beyond the FHS, along with <a href="http://gobolinux.org/index.php?lang=en_US&amp;page=doc/articles/clueless">other voices</a>, there never seemed to be any progress. We were stuck. And so I had given up and settled myself with the FHS way of doing things. (No doubt, this accounts in part for why I am so acutely aware Ruby code  that breaks under the standard.) But I have never been happy with it. I could only hope that one day, somehow, it would change. And maybe it has...</p>

<p>Are those of you using RubyGems, and using relative requires, ready to stand with your code, in defiance of the FHS, indifferent to site_ruby installation? Can we finally all say &quot;f@#k setup.rb&quot;? Can I discontinue my maintenance of the setup.rb code base? Can I now feel free to use relative require and RDoc-like <code>discover.rb</code>&#39;s to my joyous hearts abandon?</p>

<p>I wonder, is this kind of thing occurring in other language domains too, such as Perl, Python and Rebol? It would appear so. I recently learned, as one might expect, that the guys over at GoboLinux are on the forefront of this. Check out the article, <a href="http://mwh.geek.nz/2009/07/23/an-overview-of-systemaliens/">An overview of /System/Aliens</a>.</p>

<p>Is the revolt under way?</p>

<hr>

<p>title      : Quiet Revolt Against the FHS?
author     : trans
categories : [ruby, require]
date       : 2009-10-26
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2009-26-October" title="October 26, 2009">October 26, 2009</time>
            </div>
        </div>
        <hr>
    </section>
    
    
  
    <section class="index">
        <!-- -->
        <div>
            <h2 class="title"><a href="/2009/10/23/a-proper-require/" rel="prefetch">A Proper Require</a></h2>
            <p><h1>A Proper Require</h1>

<p>Recently I <a href="http://groups.google.com/group/ruby-talk-google/browse_thread/thread/6a46c837ffc84761">posted</a>
a light diatribe against improper use of relative requires in Ruby programs.
I pointed-out a bit of code, I recently came across, that added a relative path to Ruby&#39;s
<code>$LOAD_PATH</code> from within a <code>bin/</code> executable.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$LOAD_PATH.unshift(File.expand_path(File.dirname(__FILE__) + &quot;/../lib&quot;))
</code></pre></div>
<p>I suspect the author little realized that his program would not function if it were installed
according to traditional <a href="http://www.pathname.com/fhs/">FHS</a>-based standards. And I fear many
young Rubyists, having known nothing but the use of RubyGems and/or deployment (as opposed to release)
of Rails apps, do not understand the nature of the issue. In my post I stated some general rules.</p>

<h2>The Rules of Relative Loading</h2>

<ul>
<li>Don&#39;t mess with the <code>$LOAD_PATH</code>.</li>
<li>Use relative lookup only when you must, eg. using bundled HTML templates.</li>
<li>Any relative paths you do use must remain within the confines of their main directory (eg. lib/)</li>
<li>Don&#39;t use a relative lookup for any .rb or .so/.dll loading.</li>
<li>It should never be necessary to require &#39;rubygems&#39;.</li>
</ul>

<p><a href="http://blog.grayproductions.net/">James Edward Gray II</a> pointed out that
I had not been clear in stating the exceptions to these rules, so I add the
following.</p>

<h2>When the Rules Do <em>Not</em> Apply</h2>

<ul>
<li>They do not apply to Rails Apps since they are deployed, rather than packaged and installed.</li>
<li>Testing and building scripts are free from the rules since they are localized operations.</li>
</ul>

<p>Even when the rules do not apply, try to adhear to them as much as possible. For exmaple, minimize
the points of entry. At the very least it can benefit refactoring.</p>

<h2>Understanding the Rules</h2>

<p>Most of the responses to my post expressed understanding of the last rule, as there have been a few
write-ups on that subject before. But many could not understand the reasons behind the other points.
And it&#39;s no wonder. I did some research and discovered there to be a fair bit of misinformation
circulating promoting the use of relative loading as a &quot;proper&quot; solution, and very little information
explaining what is actually best practice.</p>

<p>It was the last reply to my post that made me realize I should take a moment to write this 
blog entry to more fully explain.</p>

<blockquote>
"As someone who wrote a dependency-resolving code loading gem, I am extremely
dubious that one can always avoid code loading using relative paths.
How would you ordinarily go about loading some .rb files in a subdirectory
beneath the directory in which the current file is located?"
</blockquote>

<p>Clearly we have a quite capable programmer here, having written &quot;a dependency-resolving code loading gem&quot;,
but the fact the he states that he wrote a &quot;gem&quot; rather then a &quot;library&quot; struck me as an indication
that some crucial old school knowledge is missing from his repertoire that inevitably lead him to
his second sentence.</p>

<p>The key, I believe, to alleviating this misunderstanding is Minero Aoki&#39;s <a href="http://i.loveruby.net/en/projects/setup/">Setup.rb</a>.
Before we had RubyGems, Aoki&#39;s <code>setup.rb</code> script was <em>the</em> way to install Ruby software, and his
work helped lay the foundation for the way in which Ruby projects are structured to this very day. The
first two sections of the Setup.rb <a href="http://i.loveruby.net/en/projects/setup/doc/">documentation</a>
should be required reading for all Rubyists.</p>

<p>Once we understand how Setup.rb works --where it puts a project&#39;s files upon installation, we can
then understand when we can and when we cannot get away with using relative requires. However, even
when we can do so, it does not mean we should. The idea of Setup.rb is to install your files
into the system locations where the <code>$LOAD_PATH</code> is already set to look. In other words,
you should not effect the <code>$LOAD_PATH</code> in your code, but make sure your code is where
the <code>$LOAD_PATH</code> expects it to be. The <code>$LOAD_PATH</code> is something managed externally,
by a system administrator, or a specially designed program for just such a purpose (like RubyGems).
By placing our code in the correct system locations, we will only ever need standard 
<code>require &#39;mylib/mysubdir/myfile&#39;</code> type load calls.</p>

<h2>How to Follow the Rules</h2>

<p>So how do we make sure our code is where it needs to be? In the old days we just used <code>setup.rb</code>.
By following it&#39;s conventions and installing our software with it, all was well. But today most Rubyists
use RubyGems. That works just as well, but there are two configuration issues that attend it&#39;s use.</p>

<ol>
<li>Our project&#39;s gemspec must have the proper <code>require_paths</code> setting. The default is the setup.rb standard <code>lib/</code>.</li>
<li>Our RUBYOPT environment setting must contain &quot;-rubygems&quot;.</li>
</ol>

<p>As I mentioned in the above bullet points, it is okay to add to the <code>$LOAD_PATH</code> when running tests --that&#39;s essential to avoid having to reinstall your project after every code change. But it&#39;s not acceptable to do so in your actual program.</p>

<p>I believe Minero Aoki has completed his work on Setup.rb, as there has not been any activity on his project
in some time. A while ago, I <a href="http://github.com/proutils/setup">forked Setup.rb</a> in order to make it a stand-alone package that can be installed via RubyGems. Since then I have continued it&#39;s development, working on few aspects of the system such as using optparse.rb for command-line parsing, removing the (unused) multi-package feature, adding doc/ installation and most recenty I started to rewrite the install code to be atomic (would love some assistance on that, btw!).</p>

<p>With the advent of RubyGems, <code>setup.rb</code> is not as widely needed as it once was (though it still gets used in some cases). Yet the ground work it laid is still with us, and should be understood if one wishes to be an effective Ruby programmer.</p>

<hr>

<p>title      : A Proper Require
author     : trans
categories : [ruby, require]
date       : 2009-10-23
layout     : post</p>
</p>
            <div class="meta">
                Written By <address></a> &mdash;
                <time pubdate datetime="2009-23-October" title="October 23, 2009">October 23, 2009</time>
            </div>
        </div>
        <hr>
    </section>
    
    
    <section class="pagination" style="text-align:center">
      
        
        <a href="/page4" class="btn btn-outline">‹ Newer</a>
        
      
      
        <a href="/page6" class="btn btn-outline">Older ›</a>
      
    </section>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2014 
        
        <nav>
            <a href="http://transcode.github.com">TRANS</a> &middot;
            <a href="/">Blog</a> &middot;
            <a href="http://github.com/trans">Product</a> &middot; 
            <a href="/About/">About</a>
        </nav>
        
        <nav class="social">
            
            <a href="https://twitter.com/transgigamic" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
                
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
        <p>Incorporated theme by <a href="https://sendtoinc.com">Inc</a></p>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>


</body>
</html>
