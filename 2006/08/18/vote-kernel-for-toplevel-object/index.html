<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>2006 08 18 vote kernel for toplevel object\7R4N5C0D3</title>
  <meta name="author" content="Trans" />

  <link rel="icon" type="image/png" href="/assets/images/trans-logo.png">

  <link rel="stylesheet" href="/assets/styles/main.css" type="text/css"/> 
  <link rel="stylesheet" href="/assets/styles/code.css" type="text/css"/>  
  <link rel="stylesheet" href="/assets/styles/pygment.css" type="text/css"/>

  <link rel="stylesheet" href="/assets/styles/custom.css" type="text/css"/>
  <link rel="stylesheet" href="/assets/styles/social.css" type="text/css"/>  

  <link href='http://fonts.googleapis.com/css?family=Jura:400,500' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>

  <!--[if lt IE 9]>
  <script src="/scripts/html5.js"></script>
  <![endif]-->

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

  <script type="text/javascript" src="/assets/scripts/jquery.easing.js"></script>
  <script type="text/javascript" src="/assets/scripts/jquery.social.share.1.2.min.js"></script>

  <script src="/assets/scripts/main.js"></script>

  <script>
    $(document).ready(function(){
      $('#social-share').dcSocialShare({
        twitterId: 'transgigamic',
        tabText: '<img src="/assets/images/tab_share.png" alt="Share" />',
        buttons: 'twitter,facebook,plusone,stumbleupon,digg,linkedin,pinit'
      });
    });
  </script>

  <!-- tracking code here ? -->
</head>

<body>
<div id="container">

	<div id="header">
		<h1>7R4N5C0D3</h1>
	</div>

	<div id="nav">
    <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/Projects">Projects</a></li>
    <li><a href="/Reads">Reads</a></li>
    <li><a href="/Tools">Tools</a></li>
    <li><a href="/tags.html">Tags</a></li>
    <li><a href="/atom.xml">Feed</a></li>
    <li><a href="https://github.com/trans/trans.github.com/wiki">Wiki</a> &gt;&gt;</li>
    </ul>
	</div>

<!-- CONTENT -->
<div id="content-wrapper">
<div id="content">

<h1>Vote Kernel for Toplevel Object</h1>

<p>As a follow up to my last post on the "pain that is main", I want to offer a potential improvement for Ruby 2.0. I approached the topic on ruby-talk this week and while Matz initially took some interest, he hasn't followed up since his last comment:</p>

<pre><code>matz: Why?  If it is really required it's fairly
easy to add toplevel methods like we did for #include.
</code></pre>

<p>But it isn't always easy. In order get my Taskable module to work, for instance, I had to make exceptions for the toplevel case, which is far from ideal and is fragile [Ed- in fact I'm still getting bugs that I haven't yet pinned down]. These subtile difficulties arise becuase main acts as a partial proxy for the Object class. Anyone who has created a proxy object before knows the subtile issues that can come into play. In this case, only the bare minimal interface is supported --essentially the method #include. Yet, even if we take matz' advice and add in all the missing proxy methods, we still won't be 100% out of the woods. The Object class and main are fundamentally two distinct objects --self is not the same, nor are their singleton classes, &amp;c. In the vast majority of cases this will never present an issue, but the distinction can creep in. Here's an highlight of one way it can:</p>

<div class="highlight">
<pre>  <span class="k">module</span> <span class="nn">Q</span>
    <span class="n">define_method</span> <span class="ss">:q</span> <span class="k">do</span>
      <span class="n">base</span> <span class="o">=</span> <span class="nb">self</span>
      <span class="n">define_method</span> <span class="ss">:r</span> <span class="k">do</span>
        <span class="n">base</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">C</span>
    <span class="kp">extend</span> <span class="n">Q</span>
    <span class="n">q</span>
  <span class="k">end</span>

  <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">new</span>
  <span class="nb">p</span> <span class="n">c</span><span class="o">.</span><span class="n">r</span>

  <span class="c1"># per matz' direction</span>

  <span class="k">def</span> <span class="nf">define_method</span><span class="p">(</span> <span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span> <span class="p">)</span>
    <span class="no">Object</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span>
      <span class="n">define_method</span><span class="p">(</span> <span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span> <span class="p">)</span>
      <span class="kp">private</span> <span class="nb">name</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="kp">extend</span> <span class="n">Q</span>
  <span class="n">q</span>
  <span class="nb">p</span> <span class="n">r</span>
</pre>
</div>


<p>produces</p>

<div class="highlight">
<pre>  <span class="n">true</span>
  <span class="n">false</span>
</pre>
</div>


<p>So in effect Ruby is mildly schizophrenic. The false reading is because main != Object. So, you can't necessarily create a DSL for Object to be used in main, and you can't neccessairly create a DSL for main to be used in any Object. Hence the devolution to DRYless code.</p>

<p>There is a potentially elegant solution however, and I'd really like to understand others insights into this (especially Matz' of course): Instead of main being a special proxy object, just let it be a self extended module.</p>

<div class="highlight">
<pre>  <span class="k">module</span> <span class="nn">Main</span>
    <span class="kp">extend</span> <span class="nb">self</span>
    <span class="c1"># programs are written as if in here</span>
  <span class="k">end</span>
</pre>
</div>


<p>This would provide all the facilities required of the toplevel without all the proxy troubles. Also, while I'm not so convinced of the merits of every toplevel method becoming a private method of all objects (and with Main that can be easily prevented), it has proven workable in practice so it's not a significant factor of consideration here. Main can simply be include in Object to achieve that effect.</p>

<div class="highlight">
<pre>  <span class="k">class</span> <span class="nc">Object</span>
    <span class="kp">include</span> <span class="no">Main</span>
  <span class="k">end</span>
</pre>
</div>


<p>But when we do that it becomes very clear what Main appears to be: Kernel. That strikes me as esspecially interesting. Then again, there may be good reasons to keep the Kernel as a separate module, in which case we'd just have a class hierachy:</p>

<div class="highlight">
<pre>  <span class="no">Object</span><span class="o">.</span><span class="n">ancestors</span>
  <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Object</span><span class="p">,</span> <span class="no">Main</span><span class="p">,</span> <span class="no">Kernel</span><span class="o">]</span>
</pre>
</div>


<p>Nevertheless, it is clear the Kernel could just as well serve as the toplevel object, which, IMHO, makes this an elegant proposition to consider. Perhaps I'll start a campaign as November elections roll around: "Vote Kernel for Toplevel Object!" ;-)</p>

<!--
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    {% for post in site.related_posts limit:3 %}
      <li><span class="post-date">July 07, 2012</span> &raquo; <a href="">2006 08 18 vote kernel for toplevel object</a></li>
    {% endfor %}
  </ul>
</div>
-->

</div>
</div>
<!-- END CONTENT -->

<!-- Start Shareaholic Sexybookmarks -->
<div class="shr_class shareaholic-show-on-load">
</div>

<script type="text/javascript">
var SHRSB_Settings = {"shr_class":{"src":"/assets/shareaholic","link":"","service":"236,45,5,7,88,92,61,204,202,102,3,40,10,2,38,195,27,48,6,1,218,24,46,267,74,191,265,219,210,78,240,207,54,53,52,201","apikey":"6ffe2cbf142c45bd4cd03b01ec46b8658","localize":true,"shortener":"google","shortener_key":"","designer_toolTips":true,"twitter_template":"${title} - ${short_link} via @Shareaholic"}};
</script>

<script type="text/javascript">
(function() {
var sb = document.createElement("script"); sb.type = "text/javascript";sb.async = true;
sb.src = ("https:" == document.location.protocol ? "https://dtym7iokkjlif.cloudfront.net" : "http://cdn.shareaholic.com") + "/media/js/jquery.shareaholic-publishers-sb.min.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(sb, s);
})();
</script>
<!-- End Shareaholic Sexybookmarks -->

<!-- Start Disqus Commments -->
<div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /**
     * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
     */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://transcode.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=transcode">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<!-- End Disqus Commands -->

<div id="social-share"></div>

<!-- FOOTER -->

<div id="footer">
  <div class="tiger">
  </div>
	<small>Last edited by <b>trans</b> on July 07, 2012.</small>
	<small style="float:right;">
		This site is a <a href="https://github.com/blog/699-making-github-more-open-git-backed-wikis">GitHub Wiki</a>
		mirror powered by <a href="http://rubyworks.github.com/smeagol">Smeagol</a>.
	</small>
</div>

</div>
</body>
</html>

