<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mocking Mocks &mdash; TRANSCODE</title>
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="TRANSCODE" />
    <meta name="title" content="Mocking Mocks ">
    <link rel="canonical" href="http://trans.github.com/2010/02/14/mocking-mocks/">
     
           
    <meta property="og:title" content="Mocking Mocks "/>
    <meta property="og:url" content="http://trans.github.com/2010/02/14/mocking-mocks/"/>
    
    
    <meta property="og:site_name" content="TRANSCODE">
</head>
<body>
    
<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
                <img src="/images/logo.png" alt="Inc">
            </a>
            <a href="/" class="home">Blog</a>
            <a href="http://incorporated.sendtoinc.com/">Product</a>
            <a href="https://tabcomputing.com/about/">About</a>
        </nav>
        <nav class="tagline">
            <span>Get a modern blog for your company</span>
            <a href="http://incorporated.sendtoinc.com/" class="btn btn-outline">Learn More</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                By <address><a rel="author" href="" title="" target="_blank"></a> &mdash;
                <time pubdate datetime="2010-14-February" title="February 14, 2010">February 14, 2010</time>
            </div>
            <h1 class="title">Mocking Mocks</h1>
            
        </header>

        <section>
            <h1>Mocking Mocks</h1>

<p>There are a variety of test-double/mocking libraries available for Ruby.
<a href="http://mocha.rubyforge.org/">Mocha</a> is probably the most well known.
<a href="http://rspec.info/">RSpec</a> comes with it&#39;s own mock library. I beleive
<a href="http://flexmock.rubyforge.org/">FlexMock</a> is the venerable older gentleman
on the block. And there are plenty of alternatives such as
<a href="http://rubyforge.org/projects/double-ruby">rr</a> and <a href="http://github.com/jm/stump">stump</a>.</p>

<p>I myself have been toying with an implementation, with a goal of maximizing ease
of use and implemetation overhead. In my pursuit I discovered something very
interesting: Ruby doesn&#39;t necessairly need a test-double library.</p>

<p>Consider the case of a pure <em>stub</em>. Ruby&#39;s Struct class makes pure stubs 
ridiculously easy.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">stub</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Hello, World!&quot;</span><span class="p">)</span>
    <span class="n">stub</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; &quot;Hello, World!&quot;</span>
</code></pre></div>
<p>And because Struct.new returns a class, they can be reused, adjusted and 
inherited, like any other Ruby class --pretty sweet.</p>

<p>How about the case of a <em>partial stubs</em>. Since Ruby supports singleton methods,
it is a simple matter of latching a new or overriding method onto an object.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">to_s</span>
      <span class="s2">&quot;mocking &quot;</span> <span class="o">+</span> <span class="k">super</span>
    <span class="k">end</span>
</code></pre></div>
<p>I mean, how easy can it get? </p>

<p>Ok. So stubs are easy, but how about <em>mocks</em>? Well, let&#39;s first consider what I
call <em>light-weight mocks</em>. These are like mocks in that the set-up conditions
on message invocations, but unlike regular mocks they are triggered during
invocation rather than awaiting a special trigger method (eg. <code>#verify</code>). Again,
these are easy in Ruby. (Note: I am using the <a href="http://proutils.github.com/ae">AE</a>
library for my assertions syntax.)</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">to_s</span>
      <span class="n">result</span> <span class="o">=</span> <span class="k">super</span>
      <span class="n">result</span><span class="o">.</span><span class="n">assert</span> <span class="o">=~</span> <span class="sr">/^my/</span>
      <span class="n">result</span>
    <span class="k">end</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">to_s</span>
</code></pre></div>
<p>I would argue in most cases light-weight mocks are more than sufficient for most
testing needs. Regular mocks have a tendency to become too enmeshed in implementation,
which creates undo maintenance headaches. Nonetheless, bare with me and we 
we see how to do regular mocks in pure Ruby as well.</p>

<p>Before we get to regular mocks we first need to consider the test <em>spy</em>. Check it out.
We will use one simple helper from Ruby Facets, called Functor.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="nb">require</span> <span class="s1">&#39;facets/functor&#39;</span>
</code></pre></div>
<p>If you are wondering, the functor is nothing more than a BasicObject that redirects
<code>#missing_method</code> calls to the block you supply it.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="no">Functor</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">|</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">rec</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">]</span>
      <span class="n">r</span>
    <span class="k">end</span>

    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
</code></pre></div>
<p>All we are doing here is intercepting the calls to <code>obj</code> by delegating through <code>spy</code>.
A record of activity is then being stored in the <code>rec</code> array. With it we can
verify, for instance, that <code>#to_s</code> was called.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">msg</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">|</span> <span class="n">op</span> <span class="o">==</span> <span class="ss">:to_s</span> <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
<p>And that it returned what was expected.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">assert</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s2">&quot;my object&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Or we can even verify how many times it was called. Lets call it two more times
to be sure.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="o">|</span> <span class="n">op</span> <span class="p">}</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="ss">:to_s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<p>A little verbose, but nothing too terribly strenuous to understand.</p>

<p>Alright. So now lets turn to full-fledge <em>mocks</em>. As you might have
suspected, mocks are a trivial derivation of spies. All we need to do
is collect our verifications together on a per-method bases and run
through them subsequent to invocations in question.</p>

<p>First lets reset our target object and spy.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;my object&quot;</span>

    <span class="n">rec</span> <span class="o">=</span> <span class="o">[]</span>

    <span class="n">spy</span> <span class="o">=</span> <span class="no">Functor</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">|</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
      <span class="n">rec</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">]</span>
      <span class="n">r</span>
    <span class="k">end</span>
</code></pre></div>
<p>We will store out verifications in a Hash.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">verify</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]=[]</span> <span class="p">}</span>
</code></pre></div>
<p>We define our verification procedures.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">verify</span><span class="o">[</span><span class="ss">:to_s</span><span class="o">]</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">recs</span><span class="o">|</span> 
      <span class="n">recs</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="s2">&quot;my object&quot;</span>
      <span class="n">recs</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">end</span>
</code></pre></div>
<p>Now we can execute the code in question.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">spy</span><span class="o">.</span><span class="n">to_s</span>
</code></pre></div>
<p>And verify by iterating over and calling each verification procedure.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="n">verify</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">vop</span><span class="p">,</span> <span class="n">tst</span><span class="o">|</span>
      <span class="n">recs</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">select</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">|</span> <span class="n">vop</span> <span class="o">==</span> <span class="n">op</span> <span class="p">}</span>
      <span class="n">tst</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span>
    <span class="k">end</span>
</code></pre></div>
<p>Granted that by the time we get to mocks, the code has gotten a little
more complex and certainly not as pretty as a dedicated mock library.
Nonetheless, what is remarkable here is that it takes so little to get
so much out of Ruby. With a few helper methods wrapping some of the
above code segments we would hardly know we weren&#39;t working with
a full-fledged mocking library.</p>

<p>Moreover as I argued above, one rarely needs to go this far to get
perfectly good test-doubles. Light-weight mocks will cover most
contingencies just as well as their full-fledged brethren without
the worry of taking your tests too far into the realm of implementation
detail.</p>

<hr>

<p>title      : Mocking Mocks
author     : trans
date       : 2010-02-14
categories : [tdd, bdd, test, mock]</p>

<h2>layout     : post</h2>

            
        </section>

        <footer>
            <address>
               
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank"></a></strong><br>
                <span class="muted"></span>
                </p>
            </address>

        </footer>

        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2014 
        
        <nav>
            <a href="http://tabcomputing.com/">Tab Computing</a> &middot;
            <a href="/">Blog</a> &middot;
            <a href="http://incorporated.sendtoinc.com/">Product</a> &middot; 
            <a href="https://tabcomputing.com/about/">About</a>
        </nav>
        
        <nav class="social">
            
                
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
        <p>Incorporated theme by <a href="https://sendtoinc.com">Inc</a></p>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>






</body>
</html>
