<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>About Those Refinements &mdash; TRANSCODE</title>
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/trans-logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="TRANSCODE" />
    <meta name="title" content="About Those Refinements ">
    <link rel="canonical" href="http://trans.github.com/2012/12/04/about-those-refinements/">
     
           
    <meta property="og:title" content="About Those Refinements "/>
    <meta property="og:url" content="http://trans.github.com/2012/12/04/about-those-refinements/"/>
    
    
    <meta property="og:site_name" content="TRANSCODE">
</head>
<body>
    
<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
                <img src="/images/trans-logo.png" alt="Inc" height="120px">
            </a>
            <a href="/" class="home">Blog</a>
            <a href="http://github.com/trans">Github</a>
            <a href="/About/">About</a>
        </nav>
        <nav class="tagline">
            <span>Check out all of my open source work</span>
            <a href="http://github.com/trans" class="btn btn-outline">Learn More</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                By <address><a rel="author" href="http://trans.github.com" title="trans" target="_blank">trans</a> &mdash;
                <time pubdate datetime="2012-04-December" title="December 04, 2012">December 04, 2012</time>
            </div>
            <h1 class="title">About Those Refinements</h1>
            
        </header>

        <section>
            <h1>About those Refinements</h1>

<p>Well, after a ridiculously long discussion about refinements, it&#39;s finally become clear what Matz is up to. It would have helped if he had mentioned from the start that he&#39;s patterning them directly off of Smalltalk wrappers and CLOS method combinations. Instead we get <a href="http://bugs.ruby-lang.org/projects/ruby-trunk/wiki/RefinementsSpec">this</a> &quot;offical&quot; spec. Hardly. It was only thanks to Charles Nutters careful <a href="https://bugs.ruby-lang.org/issues/4085#note-217">analysis</a> that I was able to to get a clear picture. Oh, the time and data that could have been saved!</p>

<p>So allow me to save you all the trouble and explain refinements in very simple phrase: <em>macros des m√©thodes</em>. In plain English, they are macros that act on method invocations. For example,</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">M</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">string</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="n">string</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Q</span>
  <span class="n">refine</span> <span class="nb">String</span>
    <span class="k">def</span> <span class="nf">to_s</span>
      <span class="s2">&quot;Every string is </span><span class="si">#{</span><span class="k">super</span><span class="si">}</span><span class="s2">!&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">using</span> <span class="n">Q</span>

<span class="n">M</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s2">&quot;okay&quot;</span><span class="p">)</span> <span class="c1">#=&gt; &quot;okay&quot;</span>
</code></pre></div>
<p>Notice, the <code>M.string</code> method is not effected by the refinement of <code>String#to_s</code> even though it uses <code>#to_s</code> in its definition. However, if we use <code>#to_s</code> explicitly in the scope of the refinement&#39;s use we get:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="s2">&quot;okay&quot;</span><span class="o">.</span><span class="n">to_s</span> <span class="c1">#=&gt; &quot;Every string is okay!&quot;</span>
</code></pre></div>
<p>Even though that is exactly what the definition of <code>M.string</code> is, it produces the refined result instead. Since the call was explicit the refinement interceded.</p>

<p>That&#39;s really the crux of refinements. Most of the remaining questions pertain to the order in which multiple refinements interact, but it is all pretty much as one would intuit it to be, so we won&#39;t go into detail in that regard.</p>

<p>Now I thought it might be helpful to take an extreme example of what one could do with refinements and see if it leads us to anything interesting.</p>

<p>Let&#39;s take just a bare class.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Person</span>
<span class="k">end</span>
</code></pre></div>
<p>Now lets create two refinements defining two different roles a person might take.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Buyer</span>
  <span class="n">refine</span> <span class="no">Person</span> <span class="k">do</span>
    <span class="kp">attr</span> <span class="ss">:stuff</span><span class="p">,</span> <span class="ss">:money</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">money</span><span class="p">,</span> <span class="o">*</span><span class="n">stuff</span><span class="p">)</span>
      <span class="vi">@money</span> <span class="o">=</span> <span class="n">money</span><span class="o">.</span><span class="n">to_f</span>
      <span class="vi">@stuff</span> <span class="o">=</span> <span class="n">stuff</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
      <span class="vi">@stuff</span><span class="o">.</span><span class="n">push</span> <span class="n">product</span>
      <span class="vi">@money</span> <span class="o">-=</span> <span class="vi">@money</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Seller</span>
  <span class="n">refine</span> <span class="no">Person</span> <span class="k">do</span>
    <span class="kp">attr</span> <span class="ss">:stuff</span><span class="p">,</span> <span class="ss">:money</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">money</span><span class="p">,</span> <span class="o">*</span><span class="n">stuff</span><span class="p">)</span>
      <span class="vi">@money</span> <span class="o">=</span> <span class="n">money</span><span class="o">.</span><span class="n">to_f</span>
      <span class="vi">@stuff</span> <span class="o">=</span> <span class="n">stuff</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
      <span class="vi">@stuff</span><span class="o">.</span><span class="n">delete</span> <span class="n">product</span>
      <span class="vi">@money</span> <span class="o">+=</span> <span class="vi">@money</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Now let&#39;s define an activity in which persons interact as each of these roles.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">using</span> <span class="no">Seller</span>
<span class="n">using</span> <span class="no">Buyer</span>

<span class="k">class</span> <span class="nc">SalesTransaction</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">make</span><span class="p">(</span><span class="n">buyer</span><span class="p">,</span> <span class="n">seller</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
    <span class="n">buyer</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
    <span class="n">seller</span><span class="o">.</span><span class="n">sell</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Interesting? Person has no built-in behavior, and yet we&#39;ve managed to use the class to model a sales transaction and give each person state of what they own and how much money they have. And an outside interface can&#39;t find this state out unless it knows what role to apply!</p>

<p>You might recognize the pattern of this example. It is <a href="http://en.wikipedia.org/wiki/Data,_context_and_interaction">DCI</a>. Does this mean refinements are a prefect fit for DCI-based designs? Might we see a whole new paradigm in Ruby architecture built around the DCI? That&#39;s a good question. At first glance it certainly seems to be possible. But we should note a obvious downsides.</p>

<ol>
<li>Both refinements required an <code>#initialize</code> method to ensure the instance variables are initialized. So  refinements of this kind would have to be compatible in this respect in order to be used together.</li>
<li>The context, in this case <code>SalesTransaction</code>, has to exist in it&#39;s own file so only the appropriate refinements apply. There is no way to define contexts that use different refinements in the same file because refinements are applied on a per-file basis. Although, some level of cleverness could be played if certain contexts simply add additional refinements on top of those used earlier in the file.</li>
<li>While it remains to be seen, it is unlikely that an entire system written in this fashion will be very fast. Nor is entirely certain the it would very comprehensible, but perhaps that has more to do with DCI then refinements.</li>
</ol>

            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="About Those Refinements" data-related="transgigamic">Tweet</a>
    </div>
    
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>

        </section>

        <footer>
            <address>
               
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank">trans</a></strong><br>
                <span class="muted"></span>
                </p>
            </address>

        </footer>

        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2014 
        
        <nav>
            <a href="http://transcode.github.com">TRANS</a> &middot;
            <a href="/">Blog</a> &middot;
            <a href="http://github.com/trans">Product</a> &middot; 
            <a href="/About/">About</a>
        </nav>
        
        <nav class="social">
            
            <a href="https://twitter.com/transgigamic" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
                
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
        <p>Incorporated theme by <a href="https://sendtoinc.com">Inc</a></p>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>


</body>
</html>
