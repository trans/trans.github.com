<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Taskable @ 7R4N5C0D3</title>
    <meta name="author" content="Trans" />

    <link rel="icon" type="image/png" href="/assets/images/trans-logo.png">

    <link rel="stylesheet" href="/assets/styles/main.css" type="text/css"/> 
    <link rel="stylesheet" href="/assets/styles/code.css" type="text/css"/>  
    <link rel="stylesheet" href="/assets/styles/pygment.css" type="text/css"/>

    <link rel="stylesheet" href="/assets/styles/custom.css?reload=true" type="text/css"/>
    <link rel="stylesheet" href="/assets/styles/social.css?reload=true" type="text/css"/>  

    <link href='http://fonts.googleapis.com/css?family=Jura:400,500' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>

    <!--[if lt IE 9]>
    <script src="/scripts/html5.js"></script>
    <![endif]-->

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

    <script type="text/javascript" src="/assets/scripts/jquery.easing.js"></script>
    <script type="text/javascript" src="/assets/scripts/jquery.social.share.1.2.min.js"></script>

    <script src="/assets/scripts/main.js"></script>

    <script>
      $(document).ready(function(){
        $('#social-share').dcSocialShare({
          twitterId: 'transgigamic',
          tabText: '<img src="/assets/images/tab_share.png" alt="Share" />',
          buttons: 'twitter,facebook,plusone,stumbleupon,digg,linkedin,pinit'
        });
      });
    </script>

    <!-- tracking code here ? -->
</head>

<body>

  <div id="container">

		<div id="header">
			<h1>7R4N5C0D3</h1>
		</div>

		<div id="nav">
      <ul>
      <li><a href="/index.html">Index</a></li>
      <li><a href="/Home.html">Home</a></li>
      <li><a href="/Projects.html">Projects</a></li>
      <li><a href="/Reads.html">Reads</a></li>
      <li><a href="/Tools.html">Tools</a></li>
      <li><a href="https://github.com/trans/trans.github.com/wiki">Wiki</a></li>
      <li><a href="/atom.xml">Feed</a></li>
      </ul>
		</div>

<div id="content-wrapper">
<div id="content">

<div class="path" style="clear: both; float: right;" >
  12 Sep 2008
</div>

<div id="post">
<h1>Taskable</h1>

<p>On more than a few occasions I have taken a stab at writing a general
purpose task system, akin to Rake&#39;s, but one that works within the
framework of Ruby class inheritance. I recall my first attempt was
quite an unwieldy beast, and my subsequent attempts were fairly
unwieldy too, but over time they became more concise. Below is the
most concise variation yet, and I was wondering what other thought
of it -- do you see any flaws in the design; does it satisfy all the
criteria of such a system; would you find it useful; etc.</p>

<p>One issue to note about the code, is the use of the <code>*_trigger</code> methods.
I&#39;m not sure that&#39;s the best approach. My original approach was
to provide a #run method (you can see it commented out), but this
requires dividing Taskable into two parts, a module for extending and
a module for including, and I try to avoid that design when I can.</p>
<div class="highlight"><pre><code class="ruby">    <span class="k">module</span> <span class="nn">Taskable</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1"># Without an argument, returns list of tasks defined for this class.</span>
      <span class="c1">#</span>
      <span class="c1"># If a task&#39;s target name is given, will return the first</span>
      <span class="c1"># task matching the name found in the class&#39; inheritance chain.</span>
      <span class="c1"># This is important to ensure tasks are inherited in the same manner</span>
      <span class="c1"># that methods are.</span>
      <span class="k">def</span> <span class="nf">tasks</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span>
          <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to_sym</span>
          <span class="n">anc</span> <span class="o">=</span> <span class="nb">ancestors</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="no">Taskable</span><span class="p">}</span> <span class="c1">#DSL</span>
          <span class="n">t</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">;</span> <span class="n">anc</span><span class="o">.</span><span class="n">find</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">t</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">tasks</span><span class="o">[</span><span class="n">target</span><span class="o">]</span><span class="p">}</span>
          <span class="k">return</span> <span class="n">t</span>
        <span class="k">else</span>
          <span class="vi">@tasks</span> <span class="o">||=</span> <span class="p">{}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># Set a description to be used by then next defined task in this class.</span>
      <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="vi">@desc</span> <span class="o">=</span> <span class="n">description</span>
      <span class="k">end</span>

      <span class="c1"># Define a task.</span>
      <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">target_and_requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">requisite</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="o">*</span><span class="no">Task</span><span class="o">.</span><span class="n">parse_arguments</span><span class="p">(</span><span class="n">target_and_requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">[</span><span class="n">target</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">||=</span> <span class="p">(</span>
          <span class="n">tdesc</span> <span class="o">=</span> <span class="vi">@desc</span>
          <span class="vi">@desc</span> <span class="o">=</span> <span class="kp">nil</span>
          <span class="no">Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tdesc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
        <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2">_trigger&quot;</span><span class="p">){</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">}</span>  <span class="c1"># or use #run?</span>
        <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2">:task&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span> <span class="c1"># TODO: in 1.9 use instance_exec instead.</span>
      <span class="k">end</span>

      <span class="c1"># Run a task.</span>
      <span class="c1"># Hmmm... to add this would require another module (to include).</span>
      <span class="c1"># But I&#39;m not sure. Maybe trigger method is the better way?</span>
      <span class="c1">#</span>
      <span class="c1">#def run(target)</span>
      <span class="c1">#  #t = self.class.tasks(target)</span>
      <span class="c1">#  #t.run(self)</span>
      <span class="c1">#  send(&quot;#{target}_trigger&quot;)</span>
      <span class="c1">#end</span>

      <span class="c1"># = Task Class</span>
      <span class="c1">#</span>
      <span class="k">class</span> <span class="nc">Task</span>
        <span class="kp">attr</span> <span class="ss">:base</span>
        <span class="kp">attr</span> <span class="ss">:target</span>
        <span class="kp">attr</span> <span class="ss">:requisite</span>
        <span class="kp">attr</span> <span class="ss">:function</span>
        <span class="kp">attr</span> <span class="ss">:description</span>

        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">requisite</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
          <span class="vi">@base</span>        <span class="o">=</span> <span class="n">base</span>
          <span class="vi">@target</span>      <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to_sym</span>
          <span class="vi">@description</span> <span class="o">=</span> <span class="n">description</span>
          <span class="vi">@requisite</span>   <span class="o">=</span> <span class="n">requisite</span> <span class="o">||</span> <span class="o">[]</span>
          <span class="vi">@function</span>    <span class="o">=</span> <span class="n">function</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
          <span class="vi">@requisite</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">requisite</span><span class="p">)</span><span class="o">.</span><span class="n">uniq!</span>
          <span class="vi">@function</span> <span class="o">=</span> <span class="n">function</span> <span class="k">if</span> <span class="n">function</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="k">def</span> <span class="nf">prerequisite</span>
          <span class="n">base</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">select</span><span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Taskable</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
            <span class="n">a</span><span class="o">.</span><span class="n">tasks</span><span class="o">[</span><span class="n">target</span><span class="o">].</span><span class="n">requisite</span>
          <span class="p">}</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">uniq</span>
        <span class="k">end</span>

        <span class="c1"># invoke target</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
          <span class="n">rd</span> <span class="o">=</span> <span class="n">rule_dag</span>
          <span class="n">rd</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
            <span class="n">object</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">:task&quot;</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="c1">#def call(object)</span>
        <span class="c1">#  object.instance_eval(&amp;function)</span>
        <span class="c1">#end</span>

        <span class="c1"># Collect task dependencies for running.</span>
        <span class="k">def</span> <span class="nf">rule_dag</span><span class="p">(</span><span class="n">cache</span><span class="o">=[]</span><span class="p">)</span>
          <span class="n">prerequisite</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
            <span class="k">next</span> <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">tasks</span><span class="o">[</span><span class="n">r</span><span class="o">]</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rule_dag</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
            <span class="c1">#cache &lt;&lt; dep</span>
          <span class="k">end</span>
          <span class="n">cache</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="o">.</span><span class="n">to_s</span>
          <span class="n">cache</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse_arguments</span><span class="p">(</span><span class="n">name_and_reqs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">)</span>
          <span class="k">if</span> <span class="no">Hash</span><span class="o">===</span><span class="n">name_and_reqs</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">name_and_reqs</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">to_s</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="o">[</span><span class="n">name_and_reqs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">first</span><span class="o">].</span><span class="n">flatten</span>
          <span class="k">else</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">name_and_reqs</span><span class="o">.</span><span class="n">to_s</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="o">[]</span>
          <span class="k">end</span>
          <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">reqs</span><span class="p">,</span> <span class="n">action</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre>
</div>

<p>Here&#39;s a very simple <a href="http://quarry.rubyforge.org">QEDoc</a> demo/spec:</p>
<div class="highlight"><pre><code class="ruby">    <span class="k">class</span> <span class="nc">Example</span>
      <span class="kp">include</span> <span class="no">Taskable</span>

      <span class="n">task</span> <span class="ss">:task_with_no_requisites</span> <span class="k">do</span>
        <span class="n">cache</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;task_with_no_requisites&quot;</span>
      <span class="k">end</span>

      <span class="n">task</span> <span class="ss">:task_with_one_requisite</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:task_with_no_requisites</span><span class="o">]</span> <span class="k">do</span>
        <span class="n">cache</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;task_with_one_requisite&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">cache</span>
        <span class="vi">@cache</span> <span class="o">||=</span> <span class="o">[]</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">example</span> <span class="o">=</span> <span class="no">Example</span><span class="o">.</span><span class="n">new</span>
    <span class="c1">#example.run :task_with_no_requisites</span>
    <span class="n">example</span><span class="o">.</span><span class="n">task_with_no_requisites_trigger</span>
    <span class="n">example</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="o">[</span><span class="s2">&quot;task_with_no_requisites&quot;</span><span class="o">]</span>

    <span class="n">example</span> <span class="o">=</span> <span class="no">Example</span><span class="o">.</span><span class="n">new</span>
    <span class="c1">#example.run :task_with_one_requisite</span>
    <span class="n">example</span><span class="o">.</span><span class="n">task_with_one_requisite_trigger</span>
    <span class="n">example</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="o">[</span><span class="s2">&quot;task_with_no_requisites&quot;</span><span class="p">,</span> <span class="s2">&quot;task_with_one_requisite&quot;</span><span class="o">]</span>
</code></pre>
</div>

<p>So, what do you think?</p>

<hr>

<p>title      : Taskable
date       : 2008-09-12
categories : [ruby]
layout     : post</p>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span class="post-date">17 Jun 2012</span> &raquo; <a href="/2012/06/17/kill-the-proxy-and-save-toplevel.html">Kill The Proxy And Save Toplevel</a></li>
    
      <li><span class="post-date">14 Jun 2012</span> &raquo; <a href="/2012/06/14/autoload-smells-like-denmark.html">Autoload Smells Like Denmark</a></li>
    
      <li><span class="post-date">13 Jun 2012</span> &raquo; <a href="/2012/06/13/instance-variables-as-syntax-sugar.html">Instance Variables As Syntax Sugar</a></li>
    
  </ul>
</div>

</div>
</div>

<!-- Start Shareaholic Sexybookmarks -->
<div class="shr_class shareaholic-show-on-load">
</div>

<script type="text/javascript">
var SHRSB_Settings = {"shr_class":{"src":"/assets/shareaholic","link":"","service":"236,45,5,7,88,92,61,204,202,102,3,40,10,2,38,195,27,48,6,1,218,24,46,267,74,191,265,219,210,78,240,207,54,53,52,201","apikey":"6ffe2cbf142c45bd4cd03b01ec46b8658","localize":true,"shortener":"google","shortener_key":"","designer_toolTips":true,"twitter_template":"${title} - ${short_link} via @Shareaholic"}};
</script>

<script type="text/javascript">
(function() {
var sb = document.createElement("script"); sb.type = "text/javascript";sb.async = true;
sb.src = ("https:" == document.location.protocol ? "https://dtym7iokkjlif.cloudfront.net" : "http://cdn.shareaholic.com") + "/media/js/jquery.shareaholic-publishers-sb.min.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(sb, s);
})();
</script>
<!-- End Shareaholic Sexybookmarks -->

<!-- Start Disqus Commments -->
<div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /**
     * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
     */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://transcode.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=transcode">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<!-- End Disqus Commands -->

<div id="social-share"></div>


		<div id="footer">
      <div class="tiger">
      </div>
			<small>Last edited by <b></b> on 12 Sep 2008.</small>
			<small style="float:right;">
				This site is a <a href="https://github.com/blog/699-making-github-more-open-git-backed-wikis">GitHub Wiki</a>
				mirror powered by <a href="http://rubyworks.github.com/smeagol">Smeagol</a>.
			</small>
		</div>

  </div>

</body>
</html>
