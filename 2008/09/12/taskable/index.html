<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruby AOP Made Simple &mdash; TRANSCODE</title>
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/logo.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="TRANSCODE" />
    <meta name="title" content="Ruby AOP Made Simple ">
    <link rel="canonical" href="http://trans.github.com/2008/09/12/taskable/">
     
           
    <meta property="og:title" content="Ruby AOP Made Simple "/>
    <meta property="og:url" content="http://trans.github.com/2008/09/12/taskable/"/>
    
    
    <meta property="og:site_name" content="TRANSCODE">
</head>
<body>
    
<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
                <img src="/images/logo.png" alt="Inc">
            </a>
            <a href="/" class="home">Blog</a>
            <a href="http://incorporated.sendtoinc.com/">Product</a>
            <a href="https://tabcomputing.com/about/">About</a>
        </nav>
        <nav class="tagline">
            <span>Get a modern blog for your company</span>
            <a href="http://incorporated.sendtoinc.com/" class="btn btn-outline">Learn More</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                By <address><a rel="author" href="" title="trans" target="_blank">trans</a> &mdash;
                <time pubdate datetime="2008-12-September" title="September 12, 2008">September 12, 2008</time>
            </div>
            <h1 class="title">Ruby AOP Made Simple</h1>
            
        </header>

        <section>
            <h1>Taskable</h1>

<p>On more than a few occasions I have taken a stab at writing a general
purpose task system, akin to Rake&#39;s, but one that works within the
framework of Ruby class inheritance. I recall my first attempt was
quite an unwieldy beast, and my subsequent attempts were fairly
unwieldy too, but over time they became more concise. Below is the
most concise variation yet, and I was wondering what other thought
of it -- do you see any flaws in the design; does it satisfy all the
criteria of such a system; would you find it useful; etc.</p>

<p>One issue to note about the code, is the use of the <code>*_trigger</code> methods.
I&#39;m not sure that&#39;s the best approach. My original approach was
to provide a #run method (you can see it commented out), but this
requires dividing Taskable into two parts, a module for extending and
a module for including, and I try to avoid that design when I can.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="k">module</span> <span class="nn">Taskable</span>

      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1"># Without an argument, returns list of tasks defined for this class.</span>
      <span class="c1">#</span>
      <span class="c1"># If a task&#39;s target name is given, will return the first</span>
      <span class="c1"># task matching the name found in the class&#39; inheritance chain.</span>
      <span class="c1"># This is important to ensure tasks are inherited in the same manner</span>
      <span class="c1"># that methods are.</span>
      <span class="k">def</span> <span class="nf">tasks</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span>
          <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to_sym</span>
          <span class="n">anc</span> <span class="o">=</span> <span class="nb">ancestors</span><span class="o">.</span><span class="n">select</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="no">Taskable</span><span class="p">}</span> <span class="c1">#DSL</span>
          <span class="n">t</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">;</span> <span class="n">anc</span><span class="o">.</span><span class="n">find</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">t</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">tasks</span><span class="o">[</span><span class="n">target</span><span class="o">]</span><span class="p">}</span>
          <span class="k">return</span> <span class="n">t</span>
        <span class="k">else</span>
          <span class="vi">@tasks</span> <span class="o">||=</span> <span class="p">{}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="c1"># Set a description to be used by then next defined task in this class.</span>
      <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="vi">@desc</span> <span class="o">=</span> <span class="n">description</span>
      <span class="k">end</span>

      <span class="c1"># Define a task.</span>
      <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="n">target_and_requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">requisite</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="o">*</span><span class="no">Task</span><span class="o">.</span><span class="n">parse_arguments</span><span class="p">(</span><span class="n">target_and_requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">[</span><span class="n">target</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">||=</span> <span class="p">(</span>
          <span class="n">tdesc</span> <span class="o">=</span> <span class="vi">@desc</span>
          <span class="vi">@desc</span> <span class="o">=</span> <span class="kp">nil</span>
          <span class="no">Task</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tdesc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
        <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2">_trigger&quot;</span><span class="p">){</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">}</span>  <span class="c1"># or use #run?</span>
        <span class="n">define_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">target</span><span class="si">}</span><span class="s2">:task&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span> <span class="c1"># TODO: in 1.9 use instance_exec instead.</span>
      <span class="k">end</span>

      <span class="c1"># Run a task.</span>
      <span class="c1"># Hmmm... to add this would require another module (to include).</span>
      <span class="c1"># But I&#39;m not sure. Maybe trigger method is the better way?</span>
      <span class="c1">#</span>
      <span class="c1">#def run(target)</span>
      <span class="c1">#  #t = self.class.tasks(target)</span>
      <span class="c1">#  #t.run(self)</span>
      <span class="c1">#  send(&quot;#{target}_trigger&quot;)</span>
      <span class="c1">#end</span>

      <span class="c1"># = Task Class</span>
      <span class="c1">#</span>
      <span class="k">class</span> <span class="nc">Task</span>
        <span class="kp">attr</span> <span class="ss">:base</span>
        <span class="kp">attr</span> <span class="ss">:target</span>
        <span class="kp">attr</span> <span class="ss">:requisite</span>
        <span class="kp">attr</span> <span class="ss">:function</span>
        <span class="kp">attr</span> <span class="ss">:description</span>

        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">requisite</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
          <span class="vi">@base</span>        <span class="o">=</span> <span class="n">base</span>
          <span class="vi">@target</span>      <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to_sym</span>
          <span class="vi">@description</span> <span class="o">=</span> <span class="n">description</span>
          <span class="vi">@requisite</span>   <span class="o">=</span> <span class="n">requisite</span> <span class="o">||</span> <span class="o">[]</span>
          <span class="vi">@function</span>    <span class="o">=</span> <span class="n">function</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">requisite</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">)</span>
          <span class="vi">@requisite</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">requisite</span><span class="p">)</span><span class="o">.</span><span class="n">uniq!</span>
          <span class="vi">@function</span> <span class="o">=</span> <span class="n">function</span> <span class="k">if</span> <span class="n">function</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="k">def</span> <span class="nf">prerequisite</span>
          <span class="n">base</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">select</span><span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Taskable</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
            <span class="n">a</span><span class="o">.</span><span class="n">tasks</span><span class="o">[</span><span class="n">target</span><span class="o">].</span><span class="n">requisite</span>
          <span class="p">}</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">uniq</span>
        <span class="k">end</span>

        <span class="c1"># invoke target</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
          <span class="n">rd</span> <span class="o">=</span> <span class="n">rule_dag</span>
          <span class="n">rd</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
            <span class="n">object</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">:task&quot;</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="c1">#def call(object)</span>
        <span class="c1">#  object.instance_eval(&amp;function)</span>
        <span class="c1">#end</span>

        <span class="c1"># Collect task dependencies for running.</span>
        <span class="k">def</span> <span class="nf">rule_dag</span><span class="p">(</span><span class="n">cache</span><span class="o">=[]</span><span class="p">)</span>
          <span class="n">prerequisite</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
            <span class="k">next</span> <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">tasks</span><span class="o">[</span><span class="n">r</span><span class="o">]</span>
            <span class="n">t</span><span class="o">.</span><span class="n">rule_dag</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
            <span class="c1">#cache &lt;&lt; dep</span>
          <span class="k">end</span>
          <span class="n">cache</span> <span class="o">&lt;&lt;</span> <span class="n">target</span><span class="o">.</span><span class="n">to_s</span>
          <span class="n">cache</span>
        <span class="k">end</span>

        <span class="c1">#</span>
        <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse_arguments</span><span class="p">(</span><span class="n">name_and_reqs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">)</span>
          <span class="k">if</span> <span class="no">Hash</span><span class="o">===</span><span class="n">name_and_reqs</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">name_and_reqs</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">to_s</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="o">[</span><span class="n">name_and_reqs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">first</span><span class="o">].</span><span class="n">flatten</span>
          <span class="k">else</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">name_and_reqs</span><span class="o">.</span><span class="n">to_s</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="o">[]</span>
          <span class="k">end</span>
          <span class="k">return</span> <span class="n">target</span><span class="p">,</span> <span class="n">reqs</span><span class="p">,</span> <span class="n">action</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div>
<p>Here&#39;s a very simple <a href="http://quarry.rubyforge.org">QEDoc</a> demo/spec:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">    <span class="k">class</span> <span class="nc">Example</span>
      <span class="kp">include</span> <span class="no">Taskable</span>

      <span class="n">task</span> <span class="ss">:task_with_no_requisites</span> <span class="k">do</span>
        <span class="n">cache</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;task_with_no_requisites&quot;</span>
      <span class="k">end</span>

      <span class="n">task</span> <span class="ss">:task_with_one_requisite</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:task_with_no_requisites</span><span class="o">]</span> <span class="k">do</span>
        <span class="n">cache</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;task_with_one_requisite&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">cache</span>
        <span class="vi">@cache</span> <span class="o">||=</span> <span class="o">[]</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">example</span> <span class="o">=</span> <span class="no">Example</span><span class="o">.</span><span class="n">new</span>
    <span class="c1">#example.run :task_with_no_requisites</span>
    <span class="n">example</span><span class="o">.</span><span class="n">task_with_no_requisites_trigger</span>
    <span class="n">example</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="o">[</span><span class="s2">&quot;task_with_no_requisites&quot;</span><span class="o">]</span>

    <span class="n">example</span> <span class="o">=</span> <span class="no">Example</span><span class="o">.</span><span class="n">new</span>
    <span class="c1">#example.run :task_with_one_requisite</span>
    <span class="n">example</span><span class="o">.</span><span class="n">task_with_one_requisite_trigger</span>
    <span class="n">example</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">assert</span> <span class="o">==</span> <span class="o">[</span><span class="s2">&quot;task_with_no_requisites&quot;</span><span class="p">,</span> <span class="s2">&quot;task_with_one_requisite&quot;</span><span class="o">]</span>
</code></pre></div>
<p>So, what do you think?</p>

<hr>

<p>title      : Taskable
date       : 2008-09-12
categories : [ruby]
layout     : post</p>

            
        </section>

        <footer>
            <address>
               
                <p>Written by <strong><a rel="author" href="https://twitter.com/" title="" target="_blank">trans</a></strong><br>
                <span class="muted"></span>
                </p>
            </address>

        </footer>

        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2014 
        
        <nav>
            <a href="http://tabcomputing.com/">Tab Computing</a> &middot;
            <a href="/">Blog</a> &middot;
            <a href="http://incorporated.sendtoinc.com/">Product</a> &middot; 
            <a href="https://tabcomputing.com/about/">About</a>
        </nav>
        
        <nav class="social">
            
                
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
        <p>Incorporated theme by <a href="https://sendtoinc.com">Inc</a></p>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>






</body>
</html>
