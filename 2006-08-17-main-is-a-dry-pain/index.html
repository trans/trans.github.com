<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <link rel="icon" type="image/png" href="/assets/images/trans-logo.png">

    <title>7R4N5.C0D3 - 2006 08 17 main is a dry pain</title>

    <link rel="stylesheet" href="/smeagol/main.css" type="text/css"/> 
    <link rel="stylesheet" href="/smeagol/pygment.css" type="text/css"/>

    <link rel="stylesheet" href="/assets/styles/custom.css?reload=true" type="text/css"/>
    <link rel="stylesheet" href="/assets/styles/social.css?reload=true" type="text/css"/>  

    <!--[if lt IE 9]>
    <script src="/smeagol/html5.js"></script>
    <![endif]-->

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

    <script type="text/javascript" src="/assets/scripts/jquery.easing.js"></script>
    <script type="text/javascript" src="/assets/scripts/jquery.social.share.1.2.min.js"></script>

    <script src="/assets/scripts/main.js"></script>

    <script>
      $(document).ready(function(){
        $('#social-share').dcSocialShare({
          twitterId: 'transgigamic',
          tabText: '<img src="/assets/images/tab_share.png" alt="Share" />',
          buttons: 'twitter,facebook,plusone,stumbleupon,digg,linkedin,pinit'
        });
      });
    </script>

</head>

<body>
	
  <div id="container">
		<div id="header">
			<h1>7R4N5.C0D3</h1>
		</div>

    

		<div id="nav">
      <ul>
<li><a href="/">Blog</a></li>
<li><a href="/Projects/">Projects</a></li>
<li><a href="/Tools/">Tools</a></li>
<li><a href="/Reads/">Reads</a></li>
</ul>

		</div>

		<article>
      <div id="content-wrapper">
    	<div id="content">
        <div class="path" style="clear: both;" >
          <b>source</b>: 2006 08 17 main is a dry pain
        </div>

<h1>Main is a DRY Pain</h1>

<p>I have a module that depends on define_method and ancestors. It works great when I include it in other modules or classes. But if I try including it into the toplevel it fails miserably.</p>

<pre><code>NameError: undefined local variable or method `define_method' for main:Object
</code></pre>

<p>That seems fairly peculiar when you consider that defining methods at toplevel is perfectly acceptable. One must then wonder, what is this toplevel thing anyway?</p>

<div class="highlight">
<pre><span class="nb">self</span>    <span class="c1">#=&gt; main</span>
</pre>
</div>


<p>Okay, it calls itself "main". Great. But that doesn't really tell us anything. Let's check it's class:</p>

<div class="highlight">
<pre><span class="nb">self</span><span class="o">.</span><span class="n">class</span>  <span class="c1">#=&gt; Object</span>
</pre>
</div>


<p>Ah. So it's an instance of Object. An instance of Object! How is that possible? A normal instance of Object and main can't be exactly the same. Indeed, they are not.</p>

<div class="highlight">
<pre><span class="p">(</span><span class="nb">public_methods</span> <span class="o">-</span> <span class="no">Object</span><span class="o">.</span><span class="n">public_instance_methods</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span>
<span class="c1">#=&gt; ["include", "private", "public"]</span>
<span class="nb">singleton_methods</span>
<span class="c1">#=&gt; ["include", "private", "public", "to_s"]</span>
</pre>
</div>


<p>Notice include has been defined here specifically for main. So something special's going on when you include a module into the toplevel. Hmm... What about methods defined at the toplevel? If main is an instance of Object then are they singleton methods? Well, no. Turns out they get "magically" defined as private methods of the Object class itself, and main's singleton class space is actually something else entirely.</p>

<div class="highlight">
<pre><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
  <span class="k">def</span> <span class="nf">x</span><span class="p">;</span> <span class="s2">"x"</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Q</span>
  <span class="k">def</span> <span class="nf">q</span><span class="p">;</span> <span class="n">x</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">Q</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">q</span>
<span class="c1">#=&gt; NameError: undefined local variable or method 's' for #&lt;Q:0xb7ce9a3c&gt;</span>
</pre>
</div>


<p>Which means the sure solution for my problem...</p>

<div class="highlight">
<pre><span class="k">module</span> <span class="nn">Kernel</span>
  <span class="kp">include</span> <span class="no">MyModule</span>
<span class="k">end</span>
</pre>
</div>


<p>Can you guess?</p>

<div class="highlight">
<pre><span class="k">module</span> <span class="nn">M</span>
  <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="s2">"m"</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Kernel</span>
  <span class="kp">include</span> <span class="n">M</span>
<span class="k">end</span>

<span class="n">m</span>
<span class="c1">#=&gt; NameError: undefined local variable or method `m' for main:Object</span>

<span class="k">class</span> <span class="nc">Q</span>
  <span class="k">def</span> <span class="nf">q</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">Q</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">q</span>
<span class="c1">#=&gt; NameError: undefined local variable or method `m' for #&lt;Q:0xb7cbb324&gt;</span>
</pre>
</div>


<p>Lands me squre in the face of the Module Inclusion Problem.</p>

<p>All this leads me to two points. First, I'm stuck! There seems to be no solution to my problem other than rewriting a second version of my module specifically for the toplevel. Talk about lack of DRY! And 2) Why in the world isn't main a self extended module?</p>
      </div>
      </div>
    </article>

    <!-- Start Shareaholic Sexybookmark HTML-->

    <div class="shr_class shareaholic-show-on-load">
    </div>

    <!-- End Shareaholic Sexybookmark HTML -->
    <!-- Start Shareaholic Sexybookmark script -->

    <script type="text/javascript">
    var SHRSB_Settings = {"shr_class":{"src":"/assets/shareaholic","link":"","service":"236,45,5,7,88,92,61,204,202,102,3,40,10,2,38,195,27,48,6,1,218,24,46,267,74,191,265,219,210,78,240,207,54,53,52,201","apikey":"6ffe2cbf142c45bd4cd03b01ec46b8658","localize":true,"shortener":"google","shortener_key":"","designer_toolTips":true,"twitter_template":"${title} - ${short_link} via @Shareaholic"}};
    </script>

    <script type="text/javascript">
    (function() {
    var sb = document.createElement("script"); sb.type = "text/javascript";sb.async = true;
    sb.src = ("https:" == document.location.protocol ? "https://dtym7iokkjlif.cloudfront.net" : "http://cdn.shareaholic.com") + "/media/js/jquery.shareaholic-publishers-sb.min.js";
    var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(sb, s);
    })();
    </script>
    <!-- End Shareaholic Sexybookmark script -->

    <div id="comments">
      <!-- Commment vis Disqus -->
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /**
         * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
         */
        (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = 'http://transcode.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=transcode">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

		<div id="footer">
      <div class="tiger">
      </div>
			<small>Last edited by <b>trans</b> on June 14, 2012.</small>
			<small style="float:right;">
				This site is a <a href="https://github.com/blog/699-making-github-more-open-git-backed-wikis">GitHub Wiki</a>
				mirror powered by <a href="http://smeagolrb.info">Smeagol</a>.
			</small>
		</div>

  </div>

  <div id="social-share"></div>
</body>
</html>
